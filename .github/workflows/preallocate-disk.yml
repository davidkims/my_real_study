---
name: μ›ν¬ν”λ΅μ° μ¤λ¥ μ¤μΊ” λ° μ¬μ‹¤ν–‰ μ‹λ®¬λ μ΄μ…

on:
  workflow_dispatch:

permissions:
  contents: write
  actions: write

env:
  MAX_SCAN: 100000

jobs:
  scan-and-retrigger:
    runs-on: ubuntu-latest

    steps:
      - name: π“¦ μ €μ¥μ† μ²΄ν¬μ•„μ›ƒ
        uses: actions/checkout@v4

      - name: π“ logs λ””λ ‰ν† λ¦¬ λ° ν‚¤ μƒμ„±
        run: |
          mkdir -p logs
          echo "μ•”νΈν™”ν‚¤-$(date +%s)" > logs/aes.key
          echo "AES μ•”νΈν™” ν‚¤ μƒμ„± μ™„λ£"

      - name: π” μ›ν¬ν”λ΅μ° YAML λ¬Έλ²• κ²€μ‚¬ λ° μ¤λ¥ νμΌ μ¶”μ¶
        run: |
          echo "β³ YAML κ²€μ‚¬ μ‹μ‘..."
          > logs/failed_workflows.txt
          find .github/workflows -name "*.yml" | head -n $MAX_SCAN | while read FILE; do
            yamllint "$FILE" || echo "$FILE" >> logs/failed_workflows.txt
          done
          echo "π“„ μ‹¤ν¨ νμΌ λ©λ΅:"
          cat logs/failed_workflows.txt || echo "β… μ¤λ¥ μ—†μ"

      - name: π”’ μ‹¤ν¨ ν•­λ© AES256μΌλ΅ μ•”νΈν™”
        run: |
          if [ -s logs/failed_workflows.txt ]; then
            openssl enc -aes-256-cbc -salt -pbkdf2 \
              -in logs/failed_workflows.txt \
              -out logs/failed_workflows.txt.enc \
              -pass file:logs/aes.key
            rm logs/failed_workflows.txt
            echo "β… μ•”νΈν™” μ™„λ£: logs/failed_workflows.txt.enc"
          else
            echo "β μ•”νΈν™”ν•  μ‹¤ν¨ ν•­λ© μ—†μ"
          fi

      - name: π” μ¬μ‹¤ν–‰ μ‹λ®¬λ μ΄μ…μ© λ”λ―Έ μ»¤λ°‹ (μµμ…)
        if: ${{ hashFiles('logs/failed_workflows.txt.enc') != '' }}
        run: |
          echo "// dummy change for retrigger $(date)" >> .github/workflows/.retrigger.yml
          git config --global user.name "retrigger-bot"
          git config --global user.email "retrigger@example.com"
          git add .github/workflows/.retrigger.yml
          git commit -m "π” μ¬μ‹¤ν–‰ μ‹λ®¬λ μ΄μ… μλ™ μ»¤λ°‹"
          git push || echo "β οΈ ν‘Έμ‹ μ‹¤ν¨: κ¶ν• μ—†μ„ μ μμ"

      - name: π“ μ‹¤ν–‰ λ΅κ·Έ μ¶λ ¥
        run: |
          echo "π“‘ λ΅κ·Έ μ”μ•½:"
          echo "β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€"
          echo "π” YAML κ²€μ‚¬ μ™„λ£"
          echo "π” AES μ•”νΈν™” μ™„λ£: logs/failed_workflows.txt.enc"
          echo "π” μ¬μ‹¤ν–‰ μ‹λ®¬λ μ΄μ… (λ”λ―Έ μ»¤λ°‹)"
          echo "π“¦ μµλ€ κ²€μ‚¬ μ: $MAX_SCAN"
          echo "β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€"
