---
name: ì›Œí¬í”Œë¡œìš° ì˜¤ë¥˜ ìŠ¤ìº” ë° ì‹¤íŒ¨ í•­ëª© ìë™ ì¬ì‹¤í–‰

on:
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  scan-and-retry-failed-workflows:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ“ logs ë””ë ‰í† ë¦¬ ì¤€ë¹„
        run: mkdir -p logs

      - name: ğŸ” ì›Œí¬í”Œë¡œìš° YAML ë¬¸ë²• ê²€ì‚¬ ë° ì‹¤íŒ¨ í•­ëª© ì¶”ì¶œ
        run: |
          echo "â³ YAML ê²€ì‚¬ ì‹œì‘ (.github/workflows/*.yml)"
          find .github/workflows -name "*.yml" | head -n 100000 | while read FILE; do
            yamllint "$FILE" || echo "$FILE" >> logs/failed_workflows.txt
          done
          echo "ğŸ“„ ì˜¤ë¥˜ ë°œìƒí•œ íŒŒì¼:"
          cat logs/failed_workflows.txt || echo "âœ… ì˜¤ë¥˜ ì—†ìŒ"

      - name: ğŸ›‘ ì˜¤ë¥˜ ë°œìƒí•œ ì›Œí¬í”Œë¡œìš° ëª…ë‹¨ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
        id: has-failed
        run: |
          if [ -s logs/failed_workflows.txt ]; then
            echo "has_failed=true" >> $GITHUB_OUTPUT
          else
            echo "has_failed=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ” GitHub CLI ì¸ì¦
        if: steps.has-failed.outputs.has_failed == 'true'
        run: |
          echo "${{ secrets.GH_ADMIN_TOKEN }}" | gh auth login --with-token
          gh auth status

      - name: ğŸ” ì‹¤íŒ¨í•œ ì›Œí¬í”Œë¡œìš° ì¬ì‹¤í–‰
        if: steps.has-failed.outputs.has_failed == 'true'
        run: |
          echo "â³ ì˜¤ë¥˜ ë‚œ ì›Œí¬í”Œë¡œìš° ì¬ì‹¤í–‰ ì‹œì‘..."
          while read FILE; do
            WORKFLOW_NAME=$(basename "$FILE")
            echo "ğŸš€ ì¬ì‹¤í–‰ ìš”ì²­ ì¤‘: $WORKFLOW_NAME"
            gh workflow run "$WORKFLOW_NAME" || echo "âš ï¸ ì¬ì‹¤í–‰ ì‹¤íŒ¨: $WORKFLOW_NAME"
            sleep 2
          done < logs/failed_workflows.txt
          echo "âœ… ì¬ì‹¤í–‰ ìš”ì²­ ì™„ë£Œ"

      - name: ğŸ“Š ì´ë²¤íŠ¸ ë¡œê·¸ ì¶œë ¥
        run: |
          echo "ğŸ“‘ ì‹¤í–‰ ë¡œê·¸ ìš”ì•½:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ğŸ” YAML ë¬¸ë²• ê²€ì‚¬ ì™„ë£Œ"
          echo "ğŸ“„ ì‹¤íŒ¨ í•­ëª© ì €ì¥: logs/failed_workflows.txt"
          echo "ğŸ” ì‹¤íŒ¨í•œ í•­ëª© ì¬ì‹¤í–‰ ì™„ë£Œ"
          echo "ğŸ›‘ ìµœëŒ€ 10ë§Œ ê°œê¹Œì§€ ê²€ì‚¬ ì™„ë£Œ"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
