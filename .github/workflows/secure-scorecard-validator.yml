name: Secure Scorecard Validator

on:
  push:
    paths:
      - ".github/workflows/**"
      - "results.sarif"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  security-events: write
  id-token: write

jobs:
  validate-and-patch:
    name: Validate SARIF and Secure Workflows
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # âœ… SARIF ìœ íš¨ì„± ê²€ì‚¬ ë° fallback ìƒì„±
      - name: Validate SARIF format
        id: sarif-check
        run: |
          echo "ğŸ” Validating SARIF file..."
          if ! jq empty results.sarif 2>/dev/null; then
            echo "âŒ Invalid SARIF format detected!"
            echo '{
              "version": "2.1.0",
              "runs": [
                {
                  "tool": {
                    "driver": {
                      "name": "Fallback",
                      "version": "1.0.0",
                      "informationUri": "https://example.com",
                      "rules": []
                    }
                  },
                  "results": []
                }
              ]
            }' > results.sarif
            echo "fallback=true" >> "$GITHUB_OUTPUT"
          else
            echo "âœ… SARIF file is valid."
            echo "fallback=false" >> "$GITHUB_OUTPUT"
          fi

      # âœ… fallback í¬í•¨ SARIF ì—…ë¡œë“œ
      - name: Upload SARIF to Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif

      # âœ… ë³´ì•ˆ ìœ„í˜‘ ì½”ë“œ ê²€ì¶œ ë° ìë™ íŒ¨ì¹˜
      - name: Scan and patch .github/workflows/*.yml
        id: scan
        run: |
          echo "ğŸ” Scanning workflows for security risks..."
          mkdir -p patch-log
          touch patch-log/summary.log
          unsafe=false

          for file in .github/workflows/*.yml; do
            if grep -Eq 'curl|chmod\s+777|rm\s+-rf|set-env|sudo' "$file"; then
              echo "âš ï¸ Unsafe pattern found in $file"
              unsafe=true
              cp "$file" "$file.bak"
              sed -i -E 's/(curl|chmod\s+777|rm\s+-rf|set-env|sudo)/# [REMOVED UNSAFE] \1/g' "$file"
              echo "$file patched due to insecure code" >> patch-log/summary.log
            fi
          done

          echo "unsafe=$unsafe" >> "$GITHUB_OUTPUT"

      # âœ… ìˆ˜ì •ëœ ê²½ìš° ì»¤ë°‹
      - name: Commit patched workflows
        if: steps.scan.outputs.unsafe == 'true'
        run: |
          echo "ğŸ“¦ Committing secured workflows..."
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b fix/secure-workflows
          git add .github/workflows
          git commit -m "ğŸ”’ Auto-patched insecure workflow patterns"
          git push origin fix/secure-workflows

      # âœ… ìë™ PR ìƒì„±
      - name: Create Pull Request
        if: steps.scan.outputs.unsafe == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          branch: fix/secure-workflows
          delete-branch: true
          title: "ğŸ”’ Secure Workflows: Auto-patched risky commands"
          body: |
            ë³´ì•ˆ ìœ„í—˜ ìš”ì†Œê°€ í¬í•¨ëœ ì›Œí¬í”Œë¡œìš°ê°€ ìë™ ê°ì§€ë˜ì–´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤:

            **ìˆ˜ì • ë‚´ì—­:**
            ```
            $(cat patch-log/summary.log)
            ```

            âš ï¸ ë‹¤ìŒ ëª…ë ¹ì–´ê°€ ì œê±° ë˜ëŠ” ì£¼ì„ ì²˜ë¦¬ë¨: `curl`, `chmod 777`, `rm -rf`, `set-env`, `sudo`
