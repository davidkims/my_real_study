name: ğŸ› ï¸ Maximize Disk Space & Setup Directories

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  maximize-and-setup:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ§¹ Clean unnecessary packages to free up space
        run: |
          echo "ğŸ§¼ Removing unneeded packages..."
          sudo apt-get clean
          sudo apt-get autoremove -y
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
          df -h

      - name: ğŸ“¦ Allocate disk reservation file (100GB fallback)
        run: |
          echo "ğŸ“¦ ë””ìŠ¤í¬ ì˜ˆì•½ ê³µê°„ í™•ë³´ ì¤‘..."
          if sudo fallocate -l 100G /opt/.reserved_space; then
            echo "âœ… fallocate ì‚¬ìš© ì„±ê³µ"
          else
            echo "âš ï¸ fallocate ì‹¤íŒ¨: dd ë°©ì‹ìœ¼ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤"
            sudo dd if=/dev/zero of=/opt/.reserved_space bs=1M count=102400 || echo "âŒ dd ì‹¤íŒ¨: ë””ìŠ¤í¬ ìš©ëŸ‰ ë¶€ì¡±ìœ¼ë¡œ ì˜ˆì•½ ê³µê°„ í™•ë³´ ì‹¤íŒ¨"
          fi
          sudo chmod 777 /opt/.reserved_space
          df -h

      - name: ğŸ—‚ï¸ Create essential workflow directories
        run: |
          mkdir -p .github/workflows/lint
          mkdir -p .github/workflows/security
          mkdir -p .github/workflows/deploy
          mkdir -p .github/workflows/ci
          mkdir -p .github/workflows/utils
          echo "âœ… ì›Œí¬í”Œë¡œìš° ë””ë ‰í† ë¦¬ ìƒì„± ì™„ë£Œ"

      - name: ğŸ“ Create additional required directories with full access
        run: |
          sudo mkdir -p /opt/backup/{sql,teradata,nt,apache,swift,homebrew,symantec,uploads,transactions,ledger}
          sudo chmod -R 777 /opt/backup
          echo "âœ… /opt/backup í•˜ìœ„ ë””ë ‰í† ë¦¬ ì „ì²´ ìƒì„± ì™„ë£Œ"
          df -h > disk-usage.log

      - name: ğŸ“ Save disk usage report
        run: |
          mkdir -p reports
          cp disk-usage.log reports/
          echo "âœ… ë””ìŠ¤í¬ ìš©ëŸ‰ ìƒíƒœ ë³´ê³  ì €ì¥ ì™„ë£Œ"

      - name: ğŸ’¾ Commit setup to repository
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .github/workflows reports/
          git commit -m "ğŸ› ï¸ ë””ìŠ¤í¬ ìµœëŒ€ ìš©ëŸ‰ í™•ë³´ ë° ë””ë ‰í† ë¦¬/ì›Œí¬í”Œë¡œìš° ì´ˆê¸° ì„¤ì •"
          git push
        continue-on-error: true
