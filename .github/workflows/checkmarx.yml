name: Daily Secure CxFlow & Workflow Checker

on:
  schedule:
    - cron: '0 1 * * *'  # 매일 오전 1시 (KST 오전 10시)
  workflow_dispatch:

permissions:
  contents: read

jobs:
  secure-build:
    name: Checkmarx Scan + Workflow Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
      security-events: write
      actions: read

    steps:
    - name: 📁 Checkout source
      uses: actions/checkout@v4

    - name: 🧪 Validate all workflows in .github/workflows/
      run: |
        mkdir -p logs/workflow-check
        find .github/workflows -name "*.yml" -o -name "*.yaml" | while read file; do
          echo "🔍 Validating $file" | tee -a logs/workflow-check/summary.log
          yamllint "$file" >> logs/workflow-check/summary.log 2>&1 || echo "❌ Lint error in $file" >> logs/workflow-check/errors.log
        done

    - name: 🔐 Initialize Secure Directories (형상관리 시뮬레이션)
      run: |
        TIMESTAMP=$(date +"%Y%m%d-%H%M")
        export SLOT_DIR=".secure-slot/slot-${TIMESTAMP}"
        mkdir -p "$SLOT_DIR/logs" "$SLOT_DIR/reports" "$SLOT_DIR/scripts"
        chmod -R 755 "$SLOT_DIR"
        echo "✅ Created secure slot at $SLOT_DIR"

    - name: 🔍 Run Checkmarx CxFlow Scan
      uses: checkmarx-ts/checkmarx-cxflow-github-action@49d8269b14ca87910ba003d47a31fa0c7a11f2fe
      with:
        project: ${{ secrets.CHECKMARX_PROJECT }}
        team: ${{ secrets.CHECKMARX_TEAMS }}
        checkmarx_url: ${{ secrets.CHECKMARX_URL }}
        checkmarx_username: ${{ secrets.CHECKMARX_USERNAME }}
        checkmarx_password: ${{ secrets.CHECKMARX_PASSWORD }}
        checkmarx_client_secret: ${{ secrets.CHECKMARX_CLIENT_SECRET }}
        scanners: sast
        params: >
          --namespace=${{ github.repository_owner }}
          --repo-name=${{ github.event.repository.name }}
          --branch=${{ github.ref }}
          --cx-flow.filter-severity
          --cx-flow.filter-category
          --checkmarx.disable-clubbing=true
          --repo-url=${{ github.event.repository.url }}

    - name: 📤 Upload SARIF for GitHub Security Alert
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: cx.sarif

    - name: 📓 Archive Logs
      run: |
        tar czf slot-logs.tar.gz logs
        mv slot-logs.tar.gz $SLOT_DIR/
