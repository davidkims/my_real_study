name: Full Backup and Preparation Workflow

on:
  schedule:
    - cron: '0 21 * * 0'
    - cron: '10 21 * * 0'
    - cron: '20 21 * * 0'
    - cron: '30 21 * * 0'
    - cron: '40 21 * * 0'
    - cron: '50 21 * * 0'
  workflow_dispatch:

permissions:
  contents: write
  id-token: write
  pages: write

jobs:
  cleanup-and-prepare:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Initialize Markdown Report
        run: |
          echo "# ğŸ“¦ Backup Report - $(date '+%Y-%m-%d %H:%M:%S')" > backup-report.md
          echo "" >> backup-report.md
          echo "## ğŸ’¾ Initial Disk Usage" >> backup-report.md
          df -h >> backup-report.md

      - name: Delete Existing Backup Files in .github/workflows
        run: |
          echo "ğŸ§¹ ê¸°ì¡´ ë°±ì—… íŒŒì¼ ì‚­ì œ ì‹œì‘" | tee -a backup-report.md
          find .github/workflows -type f -name '*backup*' -exec rm -v {} + | tee -a backup-report.md || true
          rm -f .github/workflows/backup_files.zip || true
          echo "âœ… ê¸°ì¡´ ë°±ì—… íŒŒì¼ ì‚­ì œ ì™„ë£Œ" | tee -a backup-report.md

      - name: Create Directories and Maximize Disk Capacity
        run: |
          sudo mkdir -p /opt/backup/{sql,teradata,nt,apache,swift,homebrew,symantec,uploads,transactions,ledger}
          sudo fallocate -l 10G /opt/backup/.reserve_space || sudo dd if=/dev/zero of=/opt/backup/.reserve_space bs=1M count=10240
          sudo chmod -R 777 /opt/backup
          echo "âœ… ë””ìŠ¤í¬ ìµœëŒ€ ìš©ëŸ‰ í™•ë³´ ë° ë””ë ‰í† ë¦¬ ì¤€ë¹„ ì™„ë£Œ" | tee -a backup-report.md
          echo "\n## ğŸ“¦ Disk Usage After Directory Setup" >> backup-report.md
          df -h >> backup-report.md

      - name: Download or Simulate Backup Resources
        run: |
          echo -e "\n## ğŸ”§ Backup Resource Downloads" >> backup-report.md
          mkdir -p /opt/backup/uploads

          declare -A FILE_URLS
          FILE_URLS[mysql-backup-template.sql]="https://github.com/davidkims/backup-assets/releases/download/v1.0/mysql-backup-template.sql"
          FILE_URLS[httpd-backup.conf]="https://github.com/davidkims/backup-assets/releases/download/v1.0/httpd-backup.conf"
          FILE_URLS[swift-template.xml]="https://github.com/davidkims/backup-assets/releases/download/v1.0/swift-template.xml"
          FILE_URLS[netbackup-init.xml]="https://github.com/davidkims/backup-assets/releases/download/v1.0/netbackup-init.xml"
          FILE_URLS[brew-packages.txt]="https://github.com/davidkims/backup-assets/releases/download/v1.0/brew-packages.txt"

          for FILE in "${!FILE_URLS[@]}"; do
            URL="${FILE_URLS[$FILE]}"
            if curl -fsSL "$URL" -o "/opt/backup/uploads/$FILE"; then
              echo "- \`$FILE\`: âœ… ë‹¤ìš´ë¡œë“œ ì„±ê³µ" >> backup-report.md
            else
              echo "- \`$FILE\`: âŒ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ (ì‹œë®¬ë ˆì´ì…˜ ì²˜ë¦¬ë¨)" >> backup-report.md
              echo "[simulated content]" > /opt/backup/uploads/$FILE
              echo "âš ï¸ 404 ì˜¤ë¥˜ ë°œìƒ: $URL" >> backup-report.md
            fi
          done

          echo "âœ… ë¦¬ì†ŒìŠ¤ ë‹¤ìš´ë¡œë“œ ë˜ëŠ” ì‹œë®¬ë ˆì´ì…˜ ì™„ë£Œ" >> backup-report.md

      - name: Simulate Financial Transaction Backups and Ledger
        run: |
          echo -e "\n## ğŸ’³ ê¸ˆìœµ ê±°ë˜ ë°±ì—… ì‹œë®¬ë ˆì´ì…˜ ë° ì›ì¥" >> backup-report.md
          mkdir -p /opt/backup/transactions /opt/backup/ledger

          LEDGER=/opt/backup/ledger/transaction-ledger.csv
          echo "ê³ ê°ID,ê³ ê°ëª…,ê±°ë˜ì¢…ë¥˜,ê¸ˆì•¡,í†µí™”,ì‹œê°„" > $LEDGER

          for i in {1..10}; do
            ID="CUST$(printf '%03d' $i)"
            NAME="ê³ ê°_$i"
            TYPE=$(shuf -n 1 -e ì²´í¬ì¹´ë“œ ì‹ ìš©ì¹´ë“œ FXê±°ë˜ í™˜ìœ¨ê³ ì‹œ)
            AMOUNT=$(awk -v min=10000 -v max=500000 'BEGIN{srand(); print int(min+rand()*(max-min+1))}')
            CURRENCY=$(shuf -n 1 -e KRW USD EUR KRW/USD)
            TIME=$(date '+%Y-%m-%d %H:%M:%S')
            echo "$ID,$NAME,$TYPE,$AMOUNT,$CURRENCY,$TIME" >> $LEDGER
          done

          cp $LEDGER /opt/backup/transactions/transaction-ledger.csv
          echo "âœ… 10ê±´ì˜ ë¬´ì‘ìœ„ ê±°ë˜ ì›ì¥ ìƒì„± ì™„ë£Œ" >> backup-report.md

          TOTAL=$(awk -F',' 'NR>1 {sum+=$4} END {print sum}' $LEDGER)
          COUNT=$(cat $LEDGER | wc -l)
          AVG=$(awk -F',' 'NR>1 {sum+=$4; n++} END {if(n>0) printf "%.2f", sum/n; else print 0}' $LEDGER)

          echo -e "\n### ğŸ“Š ê±°ë˜ í†µê³„ ìš”ì•½" >> backup-report.md
          echo "- ì´ ê±°ë˜ ìˆ˜: $((COUNT - 1)) ê±´" >> backup-report.md
          echo "- ì´ ê±°ë˜ ê¸ˆì•¡: â‚©$TOTAL" >> backup-report.md
          echo "- í‰ê·  ê±°ë˜ ê¸ˆì•¡: â‚©$AVG" >> backup-report.md

      - name: Upload Assets to GitHub Release (if GH_TOKEN and tag exist)
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: nightly-backup
          files: |
            /opt/backup/uploads/*
            /opt/backup/transactions/*
            /opt/backup/ledger/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Fallback Private Authenticated Download Simulation
        run: |
          echo -e "\n## ğŸ” GitHub Private Access Simulation" >> backup-report.md
          echo "GITHUB_TOKEN ì¡´ì¬ ì—¬ë¶€: ${{ secrets.GITHUB_TOKEN != '' }}" >> backup-report.md
          echo "(ì‹¤ì œ ë‹¤ìš´ë¡œë“œ ì¸ì¦ í•„ìš” ì‹œ curl -H 'Authorization: token $GITHUB_TOKEN')" >> backup-report.md

      - name: Compress and Upload Backup Files to .github/workflows
        run: |
          zip -r .github/workflows/backup_files.zip /opt/backup backup-report.md
          echo "âœ… ë°±ì—… íŒŒì¼ ë° ë³´ê³ ì„œ ì••ì¶• ì™„ë£Œ" | tee -a backup-report.md

      - name: List Final Backup Artifact
        run: |
          ls -lh .github/workflows/backup_files.zip | tee -a backup-report.md

      - name: Upload Markdown Report
        uses: actions/upload-artifact@v4
        with:
          name: backup-markdown-report
          path: backup-report.md
