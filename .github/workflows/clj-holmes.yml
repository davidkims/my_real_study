name: Full Backup and Preparation Workflow

on:
  schedule:
    - cron: '0 21 * * 0'
    - cron: '10 21 * * 0'
    - cron: '20 21 * * 0'
    - cron: '30 21 * * 0'
    - cron: '40 21 * * 0'
    - cron: '50 21 * * 0'
  workflow_dispatch:

permissions:
  contents: write
  id-token: write
  pages: write

jobs:
  cleanup-and-prepare:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Delete Existing Backup Files in .github/workflows
        run: |
          echo "ğŸ§¹ ê¸°ì¡´ ë°±ì—… íŒŒì¼ ì‚­ì œ ì‹œì‘"
          find .github/workflows -type f -name '*backup*' -exec rm -v {} + || true
          rm -f .github/workflows/backup_files.zip || true
          echo "âœ… ê¸°ì¡´ ë°±ì—… íŒŒì¼ ì‚­ì œ ì™„ë£Œ"

      - name: Create Directories and Maximize Disk Capacity
        run: |
          sudo mkdir -p /opt/backup/sql /opt/backup/teradata /opt/backup/nt /opt/backup/apache /opt/backup/swift /opt/backup/homebrew /opt/backup/symantec
          sudo fallocate -l 10G /opt/backup/.reserve_space || sudo dd if=/dev/zero of=/opt/backup/.reserve_space bs=1M count=10240
          sudo chmod -R 777 /opt/backup
          echo "âœ… ë””ìŠ¤í¬ ìµœëŒ€ ìš©ëŸ‰ í™•ë³´ ë° ë””ë ‰í† ë¦¬ ì¤€ë¹„ ì™„ë£Œ"

      - name: Install Required Backup Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y mysql-client apache2 swift ntfs-3g curl unzip docker.io || true
          sudo chmod +x /usr/bin/mysql /usr/sbin/apache2 /usr/bin/swift || true

      - name: Attempt Teradata CLI Download (Official)
        run: |
          curl -sfLo tdicu.tar.gz https://downloads.teradata.com/download/cdn/tools/tdicu.tar.gz || true

          if [ -f tdicu.tar.gz ]; then
            FILE_TYPE=$(file tdicu.tar.gz)
            echo "ğŸ“¦ ë‹¤ìš´ë¡œë“œí•œ íŒŒì¼ í˜•ì‹: $FILE_TYPE"

            if echo "$FILE_TYPE" | grep -q 'gzip compressed data'; then
              mkdir -p /opt/backup/teradata
              tar -xzf tdicu.tar.gz -C /opt/backup/teradata
              chmod -R 755 /opt/backup/teradata
              echo "âœ… Teradata CLI ì„¤ì¹˜ ì™„ë£Œ (ê³µì‹ URL)"
            else
              echo "âŒ ì˜¤ë¥˜: ë‹¤ìš´ë¡œë“œëœ íŒŒì¼ì´ gzip í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤."
              mkdir -p /opt/backup/teradata
              mv tdicu.tar.gz /opt/backup/teradata/tdicu.invalid
              echo "<error>Invalid Teradata package format</error>" > /opt/backup/teradata/install-error.log
            fi
          else
            echo "âŒ ê³µì‹ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: tdicu.tar.gz íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            mkdir -p /opt/backup/teradata
            echo "<error>tdicu.tar.gz not found</error>" > /opt/backup/teradata/install-error.log
          fi

      - name: Fallback Download from GitHub Release
        run: |
          curl -sfLo tdicu-release.tar.gz https://github.com/davidkims/teradata-releases/releases/download/v1.0/tdicu.tar.gz || true
          if [ -f tdicu-release.tar.gz ]; then
            mkdir -p /opt/backup/teradata/github-release
            cp tdicu-release.tar.gz /opt/backup/teradata/github-release/
            echo "âœ… GitHub Releaseì—ì„œ Teradata CLI ë‹¤ìš´ë¡œë“œ ì„±ê³µ"
          else
            echo "âš ï¸ GitHub Release ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨"
          fi

      - name: Fallback Simulate Teradata CLI Install
        run: |
          mkdir -p /opt/backup/teradata/simulation
          echo "Simulating Teradata CLI installation..." > /opt/backup/teradata/simulation/README.txt
          echo "<simulated>CLI installed</simulated>" > /opt/backup/teradata/simulation/status.xml
          echo "$(date) - CLI simulated" >> /opt/backup/teradata/simulation/install.log

      - name: Fallback Docker-based Teradata CLI Setup
        run: |
          mkdir -p /opt/backup/teradata/docker
          echo "docker pull teradatalabs/tdcli" > /opt/backup/teradata/docker/pull.sh
          echo "docker run --rm teradatalabs/tdcli --version" >> /opt/backup/teradata/docker/pull.sh
          chmod +x /opt/backup/teradata/docker/pull.sh
          echo "âœ… Docker ê¸°ë°˜ ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„± ì™„ë£Œ"

      - name: Setup NT Backup Environment
        run: |
          sudo mkdir -p /opt/backup/nt/logs
          echo "<nt-backup>Ready</nt-backup>" > /opt/backup/nt/status.xml

      - name: Setup Apache Backup Configuration
        run: |
          sudo mkdir -p /opt/backup/apache/configs
          echo "Backup Apache Config at $(date)" > /opt/backup/apache/configs/httpd.conf.backup

      - name: Setup Swift ì†¡ìˆ˜ì‹  ë°±ì—…
        run: |
          sudo mkdir -p /opt/backup/swift/send /opt/backup/swift/receive
          echo "<msg><status>OK</status></msg>" > /opt/backup/swift/send/send-$(date +%Y%m%d).xml
          echo "<msg><status>OK</status></msg>" > /opt/backup/swift/receive/receive-$(date +%Y%m%d).xml

      - name: Setup Homebrew Backup Files
        run: |
          mkdir -p /opt/backup/homebrew/logs
          echo "brew list > homebrew.log" > /opt/backup/homebrew/logs/homebrew-$(date +%Y%m%d).log

      - name: Install and Setup Symantec NetBackup (Simulated)
        run: |
          sudo mkdir -p /opt/backup/symantec/install /opt/backup/symantec/config /opt/backup/symantec/logs
          echo "Simulating Symantec NetBackup installation..." > /opt/backup/symantec/install/README.txt
          echo "<netbackup>Configured</netbackup>" > /opt/backup/symantec/config/netbackup.xml
          echo "$(date) - Symantec NetBackup setup complete" >> /opt/backup/symantec/logs/install.log

      - name: Compress and Upload Backup Files to .github/workflows
        run: |
          zip -r .github/workflows/backup_files.zip /opt/backup
          echo "âœ… ë°±ì—… íŒŒì¼ ì••ì¶• ì™„ë£Œ ë° .github/workflows ê²½ë¡œì— ì—…ë¡œë“œ ì™„ë£Œ"

      - name: List Final Backup Artifact
        run: |
          ls -lh .github/workflows/backup_files.zip
