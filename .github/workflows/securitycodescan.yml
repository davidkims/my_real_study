---
name: ìë™ ë³´ì•ˆ ì„¤ì • ìµœì í™” with GH_ADMIN_TOKEN í™•ì¸ ë° PR ìƒì„±

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  secure-fix-with-token-check:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ” GH_ADMIN_TOKEN ì¡´ì¬ í™•ì¸
        id: token-check
        run: |
          if [ -z "${{ secrets.GH_ADMIN_TOKEN }}" ]; then
            echo "token_available=false" >> $GITHUB_OUTPUT
          else
            echo "token_available=true" >> $GITHUB_OUTPUT

      - name: âŒ í† í° ì—†ìŒ ì•ˆë‚´ ë° ì¤‘ë‹¨
        if: steps.token-check.outputs.token_available == 'false'
        run: |
          echo "â— GH_ADMIN_TOKENì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          echo "ğŸ› ï¸ í† í° ìƒì„± ì ˆì°¨:"
          echo "1. https://github.com/settings/tokens?type=beta ì ‘ì†"
          echo "2. ê¶Œí•œ:"
          echo "   - Contents: Read and write"
          echo "   - Actions: Read and write"
          echo "   - Workflows: Read and write"
          echo "3. ìƒì„±í•œ í† í°ì„ ë ˆí¬ì§€í† ë¦¬ì— ë“±ë¡:"
          echo "   Settings > Secrets > Actions > New repository secret"
          echo "   ì´ë¦„: GH_ADMIN_TOKEN"
          echo "ğŸ” í† í° ë“±ë¡ í›„ ì´ ì›Œí¬í”Œë¡œìš°ë¥¼ ë‹¤ì‹œ ì‹¤í–‰í•´ ì£¼ì„¸ìš”."
          exit 1

      - name: ğŸ“¦ ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        if: steps.token-check.outputs.token_available == 'true'

      - name: ğŸ”§ ë³´ì•ˆ ìµœì í™” ìˆ˜í–‰
        if: steps.token-check.outputs.token_available == 'true'
        run: |
          find .github/workflows -name "*.yml" | while read FILE; do
            sed -i 's/permissions: write/permissions: read/g' "$FILE"
            sed -i 's/id-token: write/id-token: read/g' "$FILE"
            sed -i 's/security-events: write/security-events: read/g' "$FILE"
            sed -i 's/contents: write/contents: read/g' "$FILE"
            sed -i 's/actions: write/actions: read/g' "$FILE"
          done
          echo "âœ… ë³´ì•ˆ ì„¤ì • ìë™ ìµœì í™” ì™„ë£Œ"

      - name: ğŸ” Git ì„¤ì • ë° ë¸Œëœì¹˜ í‘¸ì‹œ
        if: steps.token-check.outputs.token_available == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_ADMIN_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          BRANCH=fix/security-auto-$(date +%Y%m%d%H%M%S)
          git checkout -b $BRANCH
          git add .github/workflows
          git commit -m "ğŸ”’ ìë™ ë³´ì•ˆ ì„¤ì • ìµœì í™” ì ìš©"
          git push https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }} $BRANCH
          echo "branch=$BRANCH" >> $GITHUB_ENV

      - name: ğŸš€ PR ìƒì„±
        if: steps.token-check.outputs.token_available == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_ADMIN_TOKEN }}
        run: |
          gh auth login --with-token <<< "${GH_TOKEN}"
          gh pr create \
            --title "ğŸ”’ ìë™ ë³´ì•ˆ ì„¤ì • ìµœì í™” PR" \
            --body "ì›Œí¬í”Œë¡œìš° íŒŒì¼ ë‚´ ë³´ì•ˆ í•­ëª©ì´ 50ê°œ ì´ìƒìœ¼ë¡œ ìë™ ìµœì í™”ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤." \
            --head "$BRANCH" \
            --base "main"
          echo "âœ… PR ìë™ ìƒì„± ì™„ë£Œ"
