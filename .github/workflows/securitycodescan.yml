---
name: ë³´ì•ˆ ì´ë²¤íŠ¸ 50ê°œ ì´ìƒ ì¦ê°€ ê°ì§€ ë° ìë™ ìˆ˜ì •

on:
  schedule:
    - cron: '0 * * * *' # ë§¤ ì‹œê°„ ì‹¤í–‰
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  detect-and-fix-security-overload:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ” ë³´ì•ˆ ì´ë²¤íŠ¸ ìˆ˜ ì§‘ê³„
        id: security-count
        run: |
          echo "ğŸ” .github/workflows ë‚´ ë³´ì•ˆ ì´ë²¤íŠ¸/permissions ê²€ì‚¬ ì¤‘..."
          COUNT=$(grep -rE 'permissions:|secrets:|security-events:|actions:|id-token:|contents:' .github/workflows | wc -l)
          echo "ğŸ“Š ì´ ë³´ì•ˆ ê´€ë ¨ í•­ëª© ìˆ˜: $COUNT"
          echo "count=$COUNT" >> $GITHUB_OUTPUT

      - name: ğŸ›‘ 50ê°œ ì´ìƒì¼ ê²½ìš° ìë™ ì²˜ë¦¬ ì§„í–‰ ì—¬ë¶€ í™•ì¸
        if: ${{ steps.security-count.outputs.count > 49 }}
        run: echo "âš ï¸ 50ê°œ ì´ìƒ ê°ì§€ë¨ â†’ ìë™ ìˆ˜ì • ì§„í–‰"

      - name: ğŸ› ï¸ ìë™ ë³´ì•ˆ ì„¤ì • ìµœì í™” ì ìš©
        if: ${{ steps.security-count.outputs.count > 49 }}
        run: |
          echo "ğŸ”§ ë³´ì•ˆ ì„¤ì • ìµœì í™” ì ìš© ì¤‘..."
          find .github/workflows -name "*.yml" | while read FILE; do
            sed -i 's/permissions: write/permissions: read/g' "$FILE"
            sed -i 's/id-token: write/id-token: read/g' "$FILE"
            sed -i 's/security-events: write/security-events: read/g' "$FILE"
            sed -i 's/contents: write/contents: read/g' "$FILE"
            sed -i 's/actions: write/actions: read/g' "$FILE"
          done
          echo "âœ… ë³´ì•ˆ ê¶Œí•œì´ 'read'ë¡œ ìµœì†Œí™”ë˜ì—ˆìŠµë‹ˆë‹¤."

      - name: ğŸ”€ PRì„ ìœ„í•œ ë¸Œëœì¹˜ ìƒì„± ë° ì»¤ë°‹
        if: ${{ steps.security-count.outputs.count > 49 }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          BRANCH=fix/security-auto-$(date +%Y%m%d%H%M%S)
          git checkout -b $BRANCH
          git add .github/workflows
          git commit -m "ğŸ”’ ìë™ ë³´ì•ˆ ì„¤ì • ìµœì í™” ì ìš©"
          git push origin $BRANCH
          echo "branch=$BRANCH" >> $GITHUB_ENV

      - name: ğŸš€ PR ìƒì„±
        if: ${{ steps.security-count.outputs.count > 49 }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "ğŸ”’ ìë™ ë³´ì•ˆ ì„¤ì • ìµœì í™” PR" \
            --body "ì›Œí¬í”Œë¡œìš° íŒŒì¼ ë‚´ ë³´ì•ˆ í•­ëª©ì´ 50ê°œë¥¼ ì´ˆê³¼í•˜ì—¬ ìë™ ìµœì í™” ìˆ˜ì •ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤." \
            --head "$BRANCH" \
            --base "main"
          echo "âœ… PR ìƒì„± ì™„ë£Œ"

      - name: ğŸ“ ìˆ˜ì •ëœ diff ë¯¸ë¦¬ë³´ê¸°
        if: ${{ steps.security-count.outputs.count > 49 }}
        run: |
          echo "ğŸ“‹ ìˆ˜ì •ëœ ì›Œí¬í”Œë¡œìš° diff:"
          git --no-pager diff HEAD~1
