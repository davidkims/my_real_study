---
name: 보안 이벤트 50개 이상 증가 감지 및 자동 수정

on:
  schedule:
    - cron: '0 * * * *' # 매 시간 실행
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  detect-and-fix-security-overload:
    runs-on: ubuntu-latest

    steps:
      - name: 📦 저장소 체크아웃
        uses: actions/checkout@v4

      - name: 🔍 보안 이벤트 수 집계
        id: security-count
        run: |
          echo "🔐 .github/workflows 내 보안 이벤트/permissions 검사 중..."
          COUNT=$(grep -rE 'permissions:|secrets:|security-events:|actions:|id-token:|contents:' .github/workflows | wc -l)
          echo "📊 총 보안 관련 항목 수: $COUNT"
          echo "count=$COUNT" >> $GITHUB_OUTPUT

      - name: 🛑 50개 이상일 경우 자동 처리 진행 여부 확인
        if: ${{ steps.security-count.outputs.count > 49 }}
        run: echo "⚠️ 50개 이상 감지됨 → 자동 수정 진행"

      - name: 🛠️ 자동 보안 설정 최적화 적용
        if: ${{ steps.security-count.outputs.count > 49 }}
        run: |
          echo "🔧 보안 설정 최적화 적용 중..."
          find .github/workflows -name "*.yml" | while read FILE; do
            sed -i 's/permissions: write/permissions: read/g' "$FILE"
            sed -i 's/id-token: write/id-token: read/g' "$FILE"
            sed -i 's/security-events: write/security-events: read/g' "$FILE"
            sed -i 's/contents: write/contents: read/g' "$FILE"
            sed -i 's/actions: write/actions: read/g' "$FILE"
          done
          echo "✅ 보안 권한이 'read'로 최소화되었습니다."

      - name: 🔀 PR을 위한 브랜치 생성 및 커밋
        if: ${{ steps.security-count.outputs.count > 49 }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          BRANCH=fix/security-auto-$(date +%Y%m%d%H%M%S)
          git checkout -b $BRANCH
          git add .github/workflows
          git commit -m "🔒 자동 보안 설정 최적화 적용"
          git push origin $BRANCH
          echo "branch=$BRANCH" >> $GITHUB_ENV

      - name: 🚀 PR 생성
        if: ${{ steps.security-count.outputs.count > 49 }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "🔒 자동 보안 설정 최적화 PR" \
            --body "워크플로우 파일 내 보안 항목이 50개를 초과하여 자동 최적화 수정이 적용되었습니다." \
            --head "$BRANCH" \
            --base "main"
          echo "✅ PR 생성 완료"

      - name: 📝 수정된 diff 미리보기
        if: ${{ steps.security-count.outputs.count > 49 }}
        run: |
          echo "📋 수정된 워크플로우 diff:"
          git --no-pager diff HEAD~1
