---
name: 자동 보안 설정 최적화 with GH_ADMIN_TOKEN

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  secure-fix-with-token:
    runs-on: ubuntu-latest

    steps:
      - name: 🔍 GH_ADMIN_TOKEN 존재 확인
        id: token-check
        run: |
          if [ -z "${{ secrets.GH_ADMIN_TOKEN }}" ]; then
            echo "token_available=false" >> $GITHUB_OUTPUT
          else
            echo "token_available=true" >> $GITHUB_OUTPUT
          fi

      - name: ❌ 토큰 없음 안내 및 워크플로우 종료
        if: steps.token-check.outputs.token_available == 'false'
        run: |
          echo "❗ GH_ADMIN_TOKEN이 설정되어 있지 않습니다."
          echo "✅ 다음 절차에 따라 토큰을 생성해 주세요:"
          echo "1. https://github.com/settings/tokens?type=beta 접속"
          echo "2. 다음 권한을 활성화:"
          echo "   - Contents: Read and write"
          echo "   - Actions: Read and write"
          echo "   - Workflows: Read and write"
          echo "3. 레포지토리 → Settings → Secrets → Actions 에 다음 이름으로 등록"
          echo "   이름: GH_ADMIN_TOKEN"
          echo "🔁 토큰 등록 후 이 워크플로우를 다시 실행하세요."
          exit 1

      - name: 📦 저장소 체크아웃
        uses: actions/checkout@v4
        if: steps.token-check.outputs.token_available == 'true'

      - name: 🔧 보안 설정 최적화 적용
        if: steps.token-check.outputs.token_available == 'true'
        run: |
          echo "🔐 .github/workflows 내 보안 설정을 최소 권한으로 최적화 중..."
          find .github/workflows -name "*.yml" | while read FILE; do
            sed -i 's/permissions: write/permissions: read/g' "$FILE"
            sed -i 's/id-token: write/id-token: read/g' "$FILE"
            sed -i 's/security-events: write/security-events: read/g' "$FILE"
            sed -i 's/contents: write/contents: read/g' "$FILE"
            sed -i 's/actions: write/actions: read/g' "$FILE"
          done
          echo "✅ 보안 설정 최적화 완료"

      - name: 🛠️ 브랜치 생성 및 커밋
        if: steps.token-check.outputs.token_available == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_ADMIN_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          BRANCH=fix/security-auto-$(date +%Y%m%d%H%M%S)
          git checkout -b $BRANCH
          git add .github/workflows
          git commit -m "🔒 자동 보안 설정 최적화 적용"
          git push https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }} $BRANCH
          echo "branch=$BRANCH" >> $GITHUB_ENV

      - name: 🚀 PR 자동 생성
        if: steps.token-check.outputs.token_available == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_ADMIN_TOKEN }}
        run: |
          echo "${GH_TOKEN}" | gh auth login --with-token
          gh pr create \
            --title "🔒 자동 보안 설정 최적화 PR" \
            --body "보안 권한이 너무 높은 워크플로우 설정을 최소 권한으로 자동 수정한 PR입니다." \
            --head "$BRANCH" \
            --base "main"
          echo "✅ PR 자동 생성 완료"

      - name: 📋 수정 내역 미리 보기
        if: steps.token-check.outputs.token_available == 'true'
        run: |
          echo "📄 변경된 워크플로우 diff:"
          git --no-pager diff HEAD~1
