---
name: ìë™ ë³´ì•ˆ ì„¤ì • ìµœì í™” with GH_ADMIN_TOKEN

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  secure-fix-with-token:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ” GH_ADMIN_TOKEN ì¡´ì¬ í™•ì¸
        id: token-check
        run: |
          if [ -z "${{ secrets.GH_ADMIN_TOKEN }}" ]; then
            echo "token_available=false" >> $GITHUB_OUTPUT
          else
            echo "token_available=true" >> $GITHUB_OUTPUT
          fi

      - name: âŒ í† í° ì—†ìŒ ì•ˆë‚´ ë° ì›Œí¬í”Œë¡œìš° ì¢…ë£Œ
        if: steps.token-check.outputs.token_available == 'false'
        run: |
          echo "â— GH_ADMIN_TOKENì´ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."
          echo "âœ… ë‹¤ìŒ ì ˆì°¨ì— ë”°ë¼ í† í°ì„ ìƒì„±í•´ ì£¼ì„¸ìš”:"
          echo "1. https://github.com/settings/tokens?type=beta ì ‘ì†"
          echo "2. ë‹¤ìŒ ê¶Œí•œì„ í™œì„±í™”:"
          echo "   - Contents: Read and write"
          echo "   - Actions: Read and write"
          echo "   - Workflows: Read and write"
          echo "3. ë ˆí¬ì§€í† ë¦¬ â†’ Settings â†’ Secrets â†’ Actions ì— ë‹¤ìŒ ì´ë¦„ìœ¼ë¡œ ë“±ë¡"
          echo "   ì´ë¦„: GH_ADMIN_TOKEN"
          echo "ğŸ” í† í° ë“±ë¡ í›„ ì´ ì›Œí¬í”Œë¡œìš°ë¥¼ ë‹¤ì‹œ ì‹¤í–‰í•˜ì„¸ìš”."
          exit 1

      - name: ğŸ“¦ ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        if: steps.token-check.outputs.token_available == 'true'

      - name: ğŸ”§ ë³´ì•ˆ ì„¤ì • ìµœì í™” ì ìš©
        if: steps.token-check.outputs.token_available == 'true'
        run: |
          echo "ğŸ” .github/workflows ë‚´ ë³´ì•ˆ ì„¤ì •ì„ ìµœì†Œ ê¶Œí•œìœ¼ë¡œ ìµœì í™” ì¤‘..."
          find .github/workflows -name "*.yml" | while read FILE; do
            sed -i 's/permissions: write/permissions: read/g' "$FILE"
            sed -i 's/id-token: write/id-token: read/g' "$FILE"
            sed -i 's/security-events: write/security-events: read/g' "$FILE"
            sed -i 's/contents: write/contents: read/g' "$FILE"
            sed -i 's/actions: write/actions: read/g' "$FILE"
          done
          echo "âœ… ë³´ì•ˆ ì„¤ì • ìµœì í™” ì™„ë£Œ"

      - name: ğŸ› ï¸ ë¸Œëœì¹˜ ìƒì„± ë° ì»¤ë°‹
        if: steps.token-check.outputs.token_available == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_ADMIN_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          BRANCH=fix/security-auto-$(date +%Y%m%d%H%M%S)
          git checkout -b $BRANCH
          git add .github/workflows
          git commit -m "ğŸ”’ ìë™ ë³´ì•ˆ ì„¤ì • ìµœì í™” ì ìš©"
          git push https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }} $BRANCH
          echo "branch=$BRANCH" >> $GITHUB_ENV

      - name: ğŸš€ PR ìë™ ìƒì„±
        if: steps.token-check.outputs.token_available == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_ADMIN_TOKEN }}
        run: |
          echo "${GH_TOKEN}" | gh auth login --with-token
          gh pr create \
            --title "ğŸ”’ ìë™ ë³´ì•ˆ ì„¤ì • ìµœì í™” PR" \
            --body "ë³´ì•ˆ ê¶Œí•œì´ ë„ˆë¬´ ë†’ì€ ì›Œí¬í”Œë¡œìš° ì„¤ì •ì„ ìµœì†Œ ê¶Œí•œìœ¼ë¡œ ìë™ ìˆ˜ì •í•œ PRì…ë‹ˆë‹¤." \
            --head "$BRANCH" \
            --base "main"
          echo "âœ… PR ìë™ ìƒì„± ì™„ë£Œ"

      - name: ğŸ“‹ ìˆ˜ì • ë‚´ì—­ ë¯¸ë¦¬ ë³´ê¸°
        if: steps.token-check.outputs.token_available == 'true'
        run: |
          echo "ğŸ“„ ë³€ê²½ëœ ì›Œí¬í”Œë¡œìš° diff:"
          git --no-pager diff HEAD~1
