---
name: ì›Œí¬í”Œë¡œìš° ë³´ì•ˆ ì„¤ì • ì ê²€ (ìˆ˜ë™ PR ì•ˆë‚´ìš©)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  secure-fix-manual-pr:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ”§ ë³´ì•ˆ ì„¤ì • ìë™ ìˆ˜ì • (ì‹œë®¬ë ˆì´ì…˜)
        run: |
          echo "ğŸ” .github/workflows/*.yml ë³´ì•ˆ ì„¤ì • ìµœì í™” ì¤‘..."
          mkdir -p backup_workflows
          cp -r .github/workflows/* backup_workflows/

          find .github/workflows -name "*.yml" | while read FILE; do
            sed -i 's/permissions: write/permissions: read/g' "$FILE"
            sed -i 's/id-token: write/id-token: read/g' "$FILE"
            sed -i 's/security-events: write/security-events: read/g' "$FILE"
            sed -i 's/contents: write/contents: read/g' "$FILE"
            sed -i 's/actions: write/actions: read/g' "$FILE"
          done
          echo "âœ… ë³´ì•ˆ ì„¤ì • ìˆ˜ì • ì™„ë£Œ (ìë™ ì»¤ë°‹ì€ í•˜ì§€ ì•ŠìŒ)"

      - name: ğŸ“‹ ë³€ê²½ì‚¬í•­ diff ì¶œë ¥
        run: |
          echo "ğŸ“„ ë³€ê²½ëœ ë‚´ìš© (Diff):"
          git config user.name "temp"
          git config user.email "temp@temp.com"
          git init temp_repo
          cd temp_repo
          git init
          cp -r ../backup_workflows/* .
          git add .
          git commit -m "original workflows"
          cd ..
          cp -r .github/workflows/* temp_repo/
          cd temp_repo
          git add .
          git diff --staged
          cd ..

      - name: ğŸ“Œ ìˆ˜ë™ PR ìƒì„± ë°©ë²• ì•ˆë‚´
        run: |
          echo ""
          echo "ğŸ“˜ ìˆ˜ë™ PR ìƒì„± ë°©ë²• ì•ˆë‚´:"
          echo "1. ë¡œì»¬ ì €ì¥ì†Œì—ì„œ ë¸Œëœì¹˜ë¥¼ ìƒì„±í•˜ì„¸ìš”:"
          echo "   git checkout -b fix/security-auto-$(date +%Y%m%d%H%M)"
          echo ""
          echo "2. ì•„ë˜ ìˆ˜ì •ì‚¬í•­ì„ ë°˜ì˜í•˜ì—¬ ì§ì ‘ ìˆ˜ì •í•˜ì„¸ìš” (ì´ ì›Œí¬í”Œë¡œìš°ì—ì„œ ì¶œë ¥ëœ diffë¥¼ ì°¸ê³ ):"
          echo "   - .github/workflows/*.yml ë‚´ permissions, id-token, contents, security-events ë“± ìµœì†Œ ê¶Œí•œìœ¼ë¡œ"
          echo ""
          echo "3. ë³€ê²½ í›„ ì»¤ë°‹ ë° í‘¸ì‹œ:"
          echo "   git add .github/workflows"
          echo "   git commit -m 'ğŸ”’ ì›Œí¬í”Œë¡œìš° ë³´ì•ˆ ì„¤ì • ìˆ˜ë™ ìµœì í™”'"
          echo "   git push origin fix/security-auto-$(date +%Y%m%d%H%M)"
          echo ""
          echo "4. GitHub ì›¹ì—ì„œ Pull Requestë¥¼ ìƒì„±í•˜ì„¸ìš”."
          echo ""
          echo "âœ… ì‘ì—… ì™„ë£Œ - ìë™ í‘¸ì‹œëŠ” í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
