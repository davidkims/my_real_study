---
name: ì›Œí¬í”Œë¡œìš° ë³´ì•ˆ ì„¤ì • ì ê²€ (ìˆ˜ë™ PR + Artifacts ì œê³µ)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  secure-fix-manual-pr:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ”§ ë³´ì•ˆ ì„¤ì • ìë™ ìˆ˜ì • (ì‹œë®¬ë ˆì´ì…˜)
        run: |
          echo "ğŸ” .github/workflows/*.yml ë³´ì•ˆ ì„¤ì • ìµœì í™” ì¤‘..."
          mkdir -p backup_workflows
          cp -r .github/workflows/* backup_workflows/

          find .github/workflows -name "*.yml" | while read FILE; do
            sed -i 's/permissions: write/permissions: read/g' "$FILE"
            sed -i 's/id-token: write/id-token: read/g' "$FILE"
            sed -i 's/security-events: write/security-events: read/g' "$FILE"
            sed -i 's/contents: write/contents: read/g' "$FILE"
            sed -i 's/actions: write/actions: read/g' "$FILE"
          done
          echo "âœ… ë³´ì•ˆ ì„¤ì • ìˆ˜ì • ì™„ë£Œ (ìë™ í‘¸ì‹œëŠ” í•˜ì§€ ì•ŠìŒ)"

      - name: ğŸ“‹ ë³€ê²½ì‚¬í•­ diff ì¶œë ¥ ë° patch ì €ì¥
        run: |
          echo "ğŸ“„ ë³€ê²½ëœ ì›Œí¬í”Œë¡œìš° diff ì¶œë ¥ ì¤‘..."
          mkdir temp_repo
          cd temp_repo

          git init
          git config user.email "github-actions@github.com"
          git config user.name "github-actions"

          cp -r ../backup_workflows/* .
          git add .
          git commit -m "original workflows"

          cp -r ../.github/workflows/* .
          git add .
          echo "ğŸ” ì•„ë˜ëŠ” ë³€ê²½ëœ ë‚´ìš©ì…ë‹ˆë‹¤:"
          git diff --staged | tee ../workflows-changes.patch

          cd ..

      - name: ğŸ“ ìˆ˜ì •ëœ ì›Œí¬í”Œë¡œìš° ZIPìœ¼ë¡œ ì••ì¶•
        run: |
          zip -r secure-workflows.zip .github/workflows
          echo "âœ… ZIP íŒŒì¼ ìƒì„± ì™„ë£Œ: secure-workflows.zip"

      - name: ğŸ“¤ Artifacts ì—…ë¡œë“œ (.zip + .patch)
        uses: actions/upload-artifact@v4
        with:
          name: secure-workflow-artifacts
          path: |
            secure-workflows.zip
            workflows-changes.patch

      - name: ğŸ“Œ ìˆ˜ë™ PR ìƒì„± ë°©ë²• ì•ˆë‚´
        run: |
          echo ""
          echo "ğŸ“˜ ìˆ˜ë™ PR ìƒì„± ë°©ë²•:"
          echo ""
          echo "1. ë¡œì»¬ ì €ì¥ì†Œì—ì„œ ìƒˆë¡œìš´ ë¸Œëœì¹˜ ìƒì„±:"
          echo "   git checkout -b fix/security-auto-$(date +%Y%m%d%H%M)"
          echo ""
          echo "2. ë‹¤ìŒ ë³€ê²½ì‚¬í•­ì„ ì§ì ‘ ë°˜ì˜ (ì•„ë˜ diff ë˜ëŠ” ZIP ì°¸ê³ ):"
          echo "   - .github/workflows/*.yml ê¶Œí•œ ì„¤ì •ì„ ìµœì†Œí™”"
          echo ""
          echo "3. ì»¤ë°‹ ë° ì›ê²© í‘¸ì‹œ:"
          echo "   git add .github/workflows"
          echo "   git commit -m 'ğŸ”’ ì›Œí¬í”Œë¡œìš° ë³´ì•ˆ ì„¤ì • ìˆ˜ë™ ìµœì í™”'"
          echo "   git push origin fix/security-auto-$(date +%Y%m%d%H%M)"
          echo ""
          echo "4. GitHub ì›¹ì—ì„œ Pull Request ìƒì„±"
          echo ""
          echo "âœ… ì´ ì›Œí¬í”Œë¡œìš°ëŠ” ìë™ í‘¸ì‹œ ì—†ì´ diffì™€ zipë§Œ ì œê³µí•©ë‹ˆë‹¤."
