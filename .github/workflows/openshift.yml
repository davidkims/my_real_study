name: Full OpenShift + Docker Setup

on:
  workflow_dispatch:
  push:
    branches: ["main"]

permissions:
  contents: write
  packages: write
  id-token: write
  actions: read
  security-events: write

jobs:
  openshift-docker-setup:
    name: Full OpenShift & Docker Provisioning
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            curl wget unzip git \
            gnupg2 lsb-release ca-certificates apt-transport-https software-properties-common

      - name: Create required directories and label them
        run: |
          mkdir -p /opt/docker/{build,images,configs} /opt/openshift/{deploy,configs,logs}
          mkdir -p ~/.docker ~/.kube
          echo "Docker directories: /opt/docker/*"
          echo "OpenShift directories: /opt/openshift/*"
          echo "âœ… ë””ë ‰í† ë¦¬ ìƒì„± ë° êµ¬ì¡°í™” ì™„ë£Œ"

      - name: Set permissions on created directories
        run: |
          sudo chown -R $USER:$USER /opt/docker /opt/openshift ~/.docker ~/.kube
          sudo chmod -R 755 /opt/docker /opt/openshift ~/.docker ~/.kube
          echo "ğŸ“› ë””ë ‰í† ë¦¬ ê¶Œí•œ ì„¤ì • ì™„ë£Œ"

      - name: Install Docker
        run: |
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker.gpg
          echo \
            "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker.gpg] \
            https://download.docker.com/linux/ubuntu \
            $(lsb_release -cs) stable" | \
            sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
          sudo apt-get update
          sudo apt-get install -y docker-ce docker-ce-cli containerd.io
          sudo usermod -aG docker $USER
          echo "âœ… Docker ì„¤ì¹˜ ì™„ë£Œ ë° ê¶Œí•œ ë¶€ì—¬"

      - name: Verify Docker installation
        run: docker --version

      - name: Install OpenShift CLI (oc)
        run: |
          curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/oc/latest/linux/oc.tar.gz
          tar -xzf oc.tar.gz
          sudo mv oc /usr/local/bin/
          rm -f oc.tar.gz README.md
          echo "âœ… OpenShift CLI (oc) ì„¤ì¹˜ ì™„ë£Œ"

      - name: Create default Dockerfile if missing
        run: |
          if [ ! -f ./Dockerfile ]; then
            echo "âš ï¸ Dockerfile ì—†ìŒ. ê¸°ë³¸ íŒŒì¼ ìƒì„± ì¤‘..."
            echo "FROM ubuntu:20.04" > ./Dockerfile
            echo "ENV DEBIAN_FRONTEND=noninteractive" >> ./Dockerfile
            echo "RUN apt-get update && apt-get install -y curl --no-install-recommends && apt-get clean && rm -rf /var/lib/apt/lists/*" >> ./Dockerfile
            echo 'CMD ["sleep", "3600"]' >> ./Dockerfile
          fi

      - name: Create Docker image
        run: |
          DOCKERFILE_PATH=./Dockerfile
          if [ -f ./backend/Dockerfile ]; then
            echo "ğŸ“¦ backend/Dockerfile ê²½ë¡œ ê°ì§€ë¨"
            DOCKERFILE_PATH=./backend/Dockerfile
          fi

          docker build -f $DOCKERFILE_PATH -t ghcr.io/${{ github.repository_owner }}/demo-app:latest .
          docker tag ghcr.io/${{ github.repository_owner }}/demo-app:latest \
            ghcr.io/${{ github.repository_owner }}/demo-app:${GITHUB_SHA::12}
          echo "âœ… Docker ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ"

      - name: Log in to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Push Docker image to GHCR
        run: |
          docker push ghcr.io/${{ github.repository_owner }}/demo-app:latest
          docker push ghcr.io/${{ github.repository_owner }}/demo-app:${GITHUB_SHA::12}
          echo "âœ… ì´ë¯¸ì§€ GHCR ì—…ë¡œë“œ ì™„ë£Œ"

      - name: Validate required OpenShift secrets
        run: |
          if [ -z "${{ secrets.OPENSHIFT_SERVER }}" ] || [ -z "${{ secrets.OPENSHIFT_TOKEN }}" ]; then
            echo "âŒ OPENSHIFT_SERVER ë˜ëŠ” OPENSHIFT_TOKENì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
            exit 1
          fi
          echo "âœ… í•„ìˆ˜ ì‹œí¬ë¦¿ í™•ì¸ ì™„ë£Œ"

      - name: OpenShift login and deploy app
        run: |
          oc login ${{ secrets.OPENSHIFT_SERVER }} --token=${{ secrets.OPENSHIFT_TOKEN }} --insecure-skip-tls-verify=true
          oc new-project demo-project || echo "í”„ë¡œì íŠ¸ ì¡´ì¬í•¨"
          oc project demo-project
          oc new-app ghcr.io/${{ github.repository_owner }}/demo-app:latest --name=demo-app
          oc expose svc/demo-app
          echo "âœ… OpenShift ì•± ë°°í¬ ë° ë…¸ì¶œ ì™„ë£Œ"

      - name: Label OpenShift resources
        run: |
          oc label svc/demo-app app=demo tier=backend env=prod --overwrite
          oc label deployment/demo-app app=demo tier=backend env=prod --overwrite
          echo "ğŸ·ï¸ OpenShift ë¼ë²¨ë§ ì™„ë£Œ"

      - name: Print OpenShift route
        run: |
          ROUTE=$(oc get route demo-app -o jsonpath='{.spec.host}')
          echo "ğŸŒ ì• í”Œë¦¬ì¼€ì´ì…˜ URL: http://$ROUTE"

      - name: Clean up (Optional)
        if: always()
        run: |
          echo "ì •ë¦¬ ì‘ì—… ì™„ë£Œ ë˜ëŠ” ìƒëµ ê°€ëŠ¥"
