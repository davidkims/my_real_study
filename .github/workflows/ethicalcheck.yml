name: EthicalCheck API ë³´ì•ˆ ì ê²€

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: '39 2 * * 4'  # ë§¤ì£¼ ëª©ìš”ì¼ ì˜¤ì „ 11:39 (KST)
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  ethicalcheck_scan:
    name: ðŸ” API ë³´ì•ˆ ì ê²€ ë° ë¦¬í¬íŠ¸ ì €ìž¥
    runs-on: ubuntu-latest

    env:
      OAS_URL: "http://netbanking.apisec.ai:8080/v2/api-docs"
      EMAIL: "your-email@example.com"
      AUTH_HEADER: "Authorization: Bearer ${{ secrets.MY_API_TOKEN }}"

    steps:
      - name: ðŸ“¦ ë ˆí¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ðŸ“ ë””ìŠ¤í¬ ìŠ¬ë¡¯ ìƒì„±
        id: create-slot
        run: |
          TIMESTAMP=$(date +"%Y%m%d-%H%M%S")
          SLOT_DIR="disk-slot/slot-${TIMESTAMP}"
          echo "SLOT_DIR=$SLOT_DIR" >> $GITHUB_ENV
          mkdir -p "$SLOT_DIR/logs" "$SLOT_DIR/reports"
          echo "ðŸ“ ë””ìŠ¤í¬ ìŠ¬ë¡¯ ë””ë ‰í† ë¦¬: $SLOT_DIR"

      - name: ðŸ” EthicalCheck ì‹¤í–‰
        uses: apisec-inc/ethicalcheck-action@005fac321dd843682b1af6b72f30caaf9952c641
        with:
          oas-url: "${{ env.OAS_URL }}"
          email: "${{ env.EMAIL }}"
          sarif-result-file: "${{ env.SLOT_DIR }}/reports/ethicalcheck-results.sarif"
        env:
          HTTP_HEADERS: ${{ env.AUTH_HEADER }}

      - name: ðŸ“„ SARIF ìœ íš¨ì„± ê²€ì‚¬
        id: check-sarif
        run: |
          FILE="${{ env.SLOT_DIR }}/reports/ethicalcheck-results.sarif"
          if [ -s "$FILE" ] && jq . "$FILE" >/dev/null 2>&1; then
            echo "valid=true" >> $GITHUB_OUTPUT
            echo "âœ… SARIF íŒŒì¼ ìœ íš¨"
          else
            echo "valid=false" >> $GITHUB_OUTPUT
            echo "âŒ SARIF íŒŒì¼ì´ ìœ íš¨í•˜ì§€ ì•ŠìŒ ë˜ëŠ” ë¹„ì–´ìžˆìŒ"
          fi

      - name: â˜ï¸ GitHub SARIF ì—…ë¡œë“œ
        if: steps.check-sarif.outputs.valid == 'true'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "${{ env.SLOT_DIR }}/reports/ethicalcheck-results.sarif"

      - name: ðŸ§¾ SARIF â†’ PDF ë³€í™˜ (Markdown í›„ HTML â†’ PDF)
        if: steps.check-sarif.outputs.valid == 'true'
        run: |
          sudo apt-get update && sudo apt-get install -y pandoc wkhtmltopdf
          FILE="${{ env.SLOT_DIR }}/reports/ethicalcheck-results.sarif"
          MARKDOWN="${{ env.SLOT_DIR }}/reports/ethicalcheck-report.md"
          PDF="${{ env.SLOT_DIR }}/reports/ethicalcheck-report.pdf"

          echo "# EthicalCheck ë³´ì•ˆ ë¦¬í¬íŠ¸" > "$MARKDOWN"
          echo '```json' >> "$MARKDOWN"
          cat "$FILE" >> "$MARKDOWN"
          echo '```' >> "$MARKDOWN"

          pandoc "$MARKDOWN" -o "$PDF" || echo "âš ï¸ PDF ë³€í™˜ ì‹¤íŒ¨ (ë¬´ì‹œë¨)"

      - name: ðŸ“œ ë¦¬í¬íŠ¸ ë¡œê·¸ ìž‘ì„±
        run: |
          echo "âœ… ë¶„ì„ ì™„ë£Œ ì‹œê°„: $(date)" > "${{ env.SLOT_DIR }}/logs/scan.log"
          ls -lh "${{ env.SLOT_DIR }}/reports" >> "${{ env.SLOT_DIR }}/logs/scan.log"
