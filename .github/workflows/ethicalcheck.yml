name: EthicalCheck ë³´ì•ˆ ì ê²€ ìžë™í™”

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: '39 2 * * 4'  # ë§¤ì£¼ ëª©ìš”ì¼ ì˜¤ì „ 11:39 (KST)
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  ethicalcheck_security_scan:
    name: ðŸ” API ë³´ì•ˆ ì ê²€ ë° ë¦¬í¬íŠ¸
    runs-on: ubuntu-latest

    env:
      OAS_URL: "http://netbanking.apisec.ai:8080/v2/api-docs"  # ë¹„ê³µê°œ APIì˜ ê²½ìš° ì‹¤ì œ URLë¡œ ëŒ€ì²´
      AUTH_HEADER: "Authorization: Bearer ${{ secrets.MY_API_TOKEN }}"
      EMAIL: "your-email@example.com"

    steps:
      - name: ðŸ“¦ ë ˆí¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ðŸ“ ë””ìŠ¤í¬ ìŠ¬ë¡¯ ìƒì„±
        id: slot
        run: |
          TIMESTAMP=$(date +"%Y%m%d-%H%M%S")
          SLOT_DIR="disk-slot/slot-${TIMESTAMP}"
          echo "SLOT_DIR=$SLOT_DIR" >> $GITHUB_ENV
          mkdir -p "$SLOT_DIR/logs"
          mkdir -p "$SLOT_DIR/reports"
          echo "ðŸ“ ìƒì„±ëœ ë””ë ‰í† ë¦¬: $SLOT_DIR"

      - name: ðŸ” EthicalCheck ë³´ì•ˆ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        uses: apisec-inc/ethicalcheck-action@005fac321dd843682b1af6b72f30caaf9952c641
        with:
          oas-url: "${{ env.OAS_URL }}"
          email: "${{ env.EMAIL }}"
          sarif-result-file: "${{ env.SLOT_DIR }}/reports/ethicalcheck-results.sarif"
        env:
          HTTP_HEADERS: ${{ env.AUTH_HEADER }}  # ë¹„ê³µê°œ APIìš© í—¤ë” í¬í•¨

      - name: ðŸ“„ SARIF íŒŒì¼ ìƒíƒœ í™•ì¸
        run: |
          echo "âœ… SARIF íŒŒì¼ í™•ì¸:"
          if [[ -s "${{ env.SLOT_DIR }}/reports/ethicalcheck-results.sarif" ]]; then
            echo "SARIF íŒŒì¼ ì¡´ìž¬ ë° ìœ íš¨í•¨"
            cat "${{ env.SLOT_DIR }}/reports/ethicalcheck-results.sarif"
          else
            echo "âŒ SARIF íŒŒì¼ì´ ë¹„ì–´ ìžˆê±°ë‚˜ ìƒì„±ë˜ì§€ ì•ŠìŒ"
          fi

      - name: â˜ï¸ SARIF ì—…ë¡œë“œ (ìœ íš¨ ì‹œ)
        if: ${{ always() }}
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "${{ env.SLOT_DIR }}/reports/ethicalcheck-results.sarif"

      - name: ðŸ§¾ SARIF â†’ PDF ë³€í™˜
        if: ${{ always() }}
        run: |
          sudo apt-get update && sudo apt-get install -y pandoc
          if [[ -s "${{ env.SLOT_DIR }}/reports/ethicalcheck-results.sarif" ]]; then
            echo "ðŸ“„ SARIF PDF ë³€í™˜ ì‹œìž‘"
            pandoc "${{ env.SLOT_DIR }}/reports/ethicalcheck-results.sarif" -o "${{ env.SLOT_DIR }}/reports/ethicalcheck-report.pdf"
            echo "âœ… PDF ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ: ethicalcheck-report.pdf"
          else
            echo "âš ï¸ SARIF íŒŒì¼ì´ ì—†ìœ¼ë¯€ë¡œ PDF ë³€í™˜ ìƒëžµ"
          fi

      - name: ðŸ“œ ë¡œê·¸ ì €ìž¥
        run: |
          echo "âœ… ì‹¤í–‰ ì™„ë£Œ ì‹œê°„: $(date)" > "${{ env.SLOT_DIR }}/logs/scan.log"
          ls -lh "${{ env.SLOT_DIR }}/reports" >> "${{ env.SLOT_DIR }}/logs/scan.log"
