name: Full Backup and Preparation Workflow

on:
  schedule:
    - cron: '0 21 * * 0'
    - cron: '10 21 * * 0'
    - cron: '20 21 * * 0'
    - cron: '30 21 * * 0'
    - cron: '40 21 * * 0'
    - cron: '50 21 * * 0'
  workflow_dispatch:

permissions:
  contents: write
  id-token: write
  pages: write

jobs:
  cleanup-and-prepare:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Initialize Markdown Report
        run: |
          echo "# ğŸ“¦ Backup Report - $(date '+%Y-%m-%d %H:%M:%S')" > backup-report.md
          echo "" >> backup-report.md
          echo "## ğŸ’¾ Initial Disk Usage" >> backup-report.md
          df -h >> backup-report.md

      - name: Delete All Files in .github/workflows
        run: |
          echo "ğŸ§¹ .github/workflows ê²½ë¡œ ë‚´ ëª¨ë“  íŒŒì¼ ì‚­ì œ ì‹œì‘" | tee -a backup-report.md
          find .github/workflows -type f -exec rm -v {} + | tee -a backup-report.md || true
          echo "âœ… .github/workflows ë””ë ‰í† ë¦¬ ë‚´ ëª¨ë“  íŒŒì¼ ì‚­ì œ ì™„ë£Œ" | tee -a backup-report.md

      - name: Create Directories and Maximize Disk Capacity (Safe)
        run: |
          sudo mkdir -p /opt/backup/{sql,teradata,nt,apache,swift,homebrew,symantec,uploads,transactions,ledger,splits}
          echo "ğŸ“¦ ë””ìŠ¤í¬ ì˜ˆì•½ ê³µê°„ í™•ë³´ ì¤‘..."
          USAGE=$(df /opt | awk 'NR==2{print $5}' | sed 's/%//')
          if [ "$USAGE" -lt 90 ]; then
            if sudo fallocate -l 100G /opt/backup/.reserve_space; then
              echo "âœ… fallocate ì‚¬ìš© ì„±ê³µ"
            else
              echo "âš ï¸ fallocate ì‹¤íŒ¨: dd ë°©ì‹ìœ¼ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤"
              if sudo dd if=/dev/zero of=/opt/backup/.reserve_space bs=1M count=102400; then
                echo "âœ… dd ë°©ì‹ ì˜ˆì•½ ì„±ê³µ"
              else
                echo "âŒ dd ì‹¤íŒ¨: ë””ìŠ¤í¬ ìš©ëŸ‰ ë¶€ì¡±ìœ¼ë¡œ ì˜ˆì•½ ê³µê°„ í™•ë³´ ì‹¤íŒ¨"
              fi
            fi
          else
            echo "âš ï¸ í˜„ì¬ ë””ìŠ¤í¬ ì‚¬ìš©ë¥  ${USAGE}% ì´ìƒ. ì˜ˆì•½ ê³µê°„ ìƒì„± ìƒëµí•©ë‹ˆë‹¤." | tee -a backup-report.md
          fi
          sudo chmod -R 777 /opt/backup
          echo "âœ… ë””ìŠ¤í¬ ìµœëŒ€ ìš©ëŸ‰ í™•ë³´ ë° ë””ë ‰í† ë¦¬ ì¤€ë¹„ ì™„ë£Œ" | tee -a backup-report.md
          echo "\n## ğŸ“¦ Disk Usage After Directory Setup" >> backup-report.md
          df -h >> backup-report.md