name: Global Card Transaction Backup (Encrypted UTC/KST)

on:
  schedule:
    - cron: '*/5 * * * *'  # 5분마다 실행
  workflow_dispatch:

permissions:
  contents: write

jobs:
  card-backup:
    runs-on: ubuntu-latest

    steps:
      - name: 📦 Checkout
        uses: actions/checkout@v4

      - name: 🕒 Set UTC + KST timestamps
        id: time
        run: |
          echo "utc_time=$(date -u +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
          echo "kst_time=$(TZ=Asia/Seoul date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: 📁 Create backup directories
        run: mkdir -p checkcard_backups

      - name: 💳 Simulate Card Transactions and Encrypt
        run: |
          # 체크카드 거래 백업
          echo "-- 체크카드 거래 내역" > checkcard.sql
          echo "CREATE TABLE checkcard_transactions (id INT, customer_id INT, amount DECIMAL, masked_card TEXT);" >> checkcard.sql
          echo "INSERT INTO checkcard_transactions VALUES (1, 1001, 15000.00, '****-****-****-1234');" >> checkcard.sql

          # 신용카드 거래 백업
          echo "-- 신용카드 거래 내역" > creditcard.sql
          echo "CREATE TABLE creditcard_transactions (id INT, customer_id INT, amount DECIMAL, masked_card TEXT);" >> creditcard.sql
          echo "INSERT INTO creditcard_transactions VALUES (2, 2002, 32000.00, '****-****-****-5678');" >> creditcard.sql

          # GPG 암호화
          gpg --batch --yes --passphrase "secret" -c checkcard.sql
          gpg --batch --yes --passphrase "secret" -c creditcard.sql

          # 파일 이름에 UTC + KST 타임스탬프 포함
          mv checkcard.sql.gpg checkcard_backups/checkcard-${{ steps.time.outputs.kst_time }}-UTC${{ steps.time.outputs.utc_time }}.sql.gpg
          mv creditcard.sql.gpg checkcard_backups/creditcard-${{ steps.time.outputs.kst_time }}-UTC${{ steps.time.outputs.utc_time }}.sql.gpg

          # 원본 제거
          rm -f checkcard.sql creditcard.sql

      - name: ✅ Show backup files
        run: ls -al checkcard_backups
