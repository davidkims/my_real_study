name: Full System Setup, Backup & Report

on:
  schedule:
    - cron: '0 23 * * *'  # Îß§Ïùº Ïò§Ï†Ñ 8Ïãú (KST)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  system-backup:
    name: Apache & NT Backup Setup + Full Report
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set timestamp
        id: vars
        run: |
          echo "timestamp=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
          echo "date_fmt=$(date '+%Y-%m-%d %H:%M:%S (KST)')" >> $GITHUB_OUTPUT

      - name: Install Apache2 and setup directories
        run: |
          sudo apt-get update
          sudo apt-get install -y apache2 apache2-utils
          sudo mkdir -p /etc/apache2/auth
          sudo htpasswd -bc /etc/apache2/auth/.htpasswd admin password123
          echo '<Directory "/var/www/html">' | sudo tee /etc/apache2/conf-available/auth.conf
          echo '  AuthType Basic' | sudo tee -a /etc/apache2/conf-available/auth.conf
          echo '  AuthName "Restricted"' | sudo tee -a /etc/apache2/conf-available/auth.conf
          echo '  AuthUserFile /etc/apache2/auth/.htpasswd' | sudo tee -a /etc/apache2/conf-available/auth.conf
          echo '  Require valid-user' | sudo tee -a /etc/apache2/conf-available/auth.conf
          echo '</Directory>' | sudo tee -a /etc/apache2/conf-available/auth.conf
          sudo a2enconf auth
          sudo systemctl restart apache2

      - name: Simulate NT Backup installation
        run: |
          mkdir -p nt-backup/bin
          echo "#!/bin/bash\necho 'NT Backup service running...'" > nt-backup/bin/ntbackup
          chmod +x nt-backup/bin/ntbackup
          echo "NT backup initialized." > nt-backup/nt-service.log

      - name: Simulate Apache/NT processes (logs)
        run: |
          ps -e > apache_backups/apache-process-${{ steps.vars.outputs.timestamp }}.log || true
          echo "NT backup process simulation completed" >> nt-backup/nt-service.log

      - name: Generate backup report (Markdown)
        run: |
          mkdir -p reports
          REPORT="reports/system-backup-report-${{ steps.vars.outputs.timestamp }}.md"
          echo "# üõ°Ô∏è Full System Report - ${{ steps.vars.outputs.date_fmt }}" > "$REPORT"
          echo "" >> "$REPORT"
          echo "## ‚úÖ Apache Installation & Auth Setup" >> "$REPORT"
          echo "- Apache installed with htpasswd auth at \`/etc/apache2/auth/.htpasswd\`" >> "$REPORT"
          echo "- Config: \`/etc/apache2/conf-available/auth.conf\`" >> "$REPORT"
          echo "" >> "$REPORT"
          echo "## ‚úÖ NT Backup System Simulated" >> "$REPORT"
          echo "- Executable: \`nt-backup/bin/ntbackup\`" >> "$REPORT"
          echo "- Log file: \`nt-backup/nt-service.log\`" >> "$REPORT"
          echo "" >> "$REPORT"
          echo "## üîß Directories Created" >> "$REPORT"
          echo "- \`/etc/apache2\`, \`apache_backups/\`, \`nt-backup/\`" >> "$REPORT"
          echo "" >> "$REPORT"
          echo "## üìÑ Process Log" >> "$REPORT"
          echo "- \`apache_backups/apache-process-${{ steps.vars.outputs.timestamp }}.log\`" >> "$REPORT"
          echo "" >> "$REPORT"
          echo "---" >> "$REPORT"
          echo "_Auto-generated by GitHub Actions_" >> "$REPORT"

      - name: Commit and push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git pull origin ${{ github.ref_name }}
          git add nt-backup/ apache_backups/ reports/*.md
          git commit -m "üõ†Ô∏è Full system install & report at ${{ steps.vars.outputs.timestamp }}" || echo "Nothing to commit"
          git push origin ${{ github.ref_name }}
