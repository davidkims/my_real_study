name: Full Backup and Preparation Workflow

on:
  schedule:
    - cron: '0 21 * * 0'
    - cron: '10 21 * * 0'
    - cron: '20 21 * * 0'
    - cron: '30 21 * * 0'
    - cron: '40 21 * * 0'
    - cron: '50 21 * * 0'
  workflow_dispatch:

permissions:
  contents: write
  id-token: write
  pages: write

jobs:
  cleanup-and-prepare:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Initialize Markdown Report
        run: |
          echo "# ğŸ“¦ Backup Report - $(date '+%Y-%m-%d %H:%M:%S')" > backup-report.md
          echo "" >> backup-report.md
          echo "## ğŸ’¾ Initial Disk Usage" >> backup-report.md
          df -h >> backup-report.md

      - name: Delete Existing Backup Files in .github/workflows
        run: |
          echo "ğŸ§¹ ê¸°ì¡´ ë°±ì—… íŒŒì¼ ì‚­ì œ ì‹œì‘" | tee -a backup-report.md
          find .github/workflows -type f -name '*backup*' -exec rm -v {} + | tee -a backup-report.md || true
          rm -f .github/workflows/backup_files.zip || true
          echo "âœ… ê¸°ì¡´ ë°±ì—… íŒŒì¼ ì‚­ì œ ì™„ë£Œ" | tee -a backup-report.md

      - name: Create Directories and Maximize Disk Capacity (Fallback dd only)
        run: |
          sudo mkdir -p /opt/backup/{sql,teradata,nt,apache,swift,homebrew,symantec,uploads,transactions,ledger}
          echo "ğŸ“¦ ë””ìŠ¤í¬ ì˜ˆì•½ ê³µê°„ í™•ë³´ ì¤‘..."
          if sudo fallocate -l 100G /opt/backup/.reserve_space; then
            echo "âœ… fallocate ì‚¬ìš© ì„±ê³µ"
          else
            echo "âš ï¸ fallocate ì‹¤íŒ¨: dd ë°©ì‹ìœ¼ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤"
            sudo dd if=/dev/zero of=/opt/backup/.reserve_space bs=1M count=102400 || echo "âŒ dd ì‹¤íŒ¨: ë””ìŠ¤í¬ ìš©ëŸ‰ ë¶€ì¡±ìœ¼ë¡œ ì˜ˆì•½ ê³µê°„ í™•ë³´ ì‹¤íŒ¨"
          fi
          sudo chmod -R 777 /opt/backup
          echo "âœ… ë””ìŠ¤í¬ ìµœëŒ€ ìš©ëŸ‰ í™•ë³´ ë° ë””ë ‰í† ë¦¬ ì¤€ë¹„ ì™„ë£Œ" | tee -a backup-report.md
          echo "\n## ğŸ“¦ Disk Usage After Directory Setup" >> backup-report.md
          df -h >> backup-report.md
