name: Full Backup and Preparation Workflow

on:
  schedule:
    - cron: '0 21 * * 0'
    - cron: '10 21 * * 0'
    - cron: '20 21 * * 0'
    - cron: '30 21 * * 0'
    - cron: '40 21 * * 0'
    - cron: '50 21 * * 0'
  workflow_dispatch:

permissions:
  contents: write
  id-token: write
  pages: write

jobs:
  cleanup-and-prepare:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Initialize Markdown Report
        run: |
          echo "# ðŸ“¦ Backup Report - $(date '+%Y-%m-%d %H:%M:%S')" > backup-report.md
          echo "" >> backup-report.md
          echo "## ðŸ’¾ Initial Disk Usage" >> backup-report.md
          df -h >> backup-report.md

      - name: Delete Existing Backup Files in .github/workflows
        run: |
          echo "ðŸ§¹ ê¸°ì¡´ ë°±ì—… íŒŒì¼ ì‚­ì œ ì‹œìž‘" | tee -a backup-report.md
          find .github/workflows -type f -name '*backup*' -exec rm -v {} + | tee -a backup-report.md || true
          rm -f .github/workflows/backup_files.zip || true
          echo "âœ… ê¸°ì¡´ ë°±ì—… íŒŒì¼ ì‚­ì œ ì™„ë£Œ" | tee -a backup-report.md

      - name: Create Directories and Maximize Disk Capacity (Fallback dd only)
        run: |
          sudo mkdir -p /opt/backup/{sql,teradata,nt,apache,swift,homebrew,symantec,uploads,transactions,ledger}
          echo "ðŸ“¦ ë””ìŠ¤í¬ ì˜ˆì•½ ê³µê°„ í™•ë³´ ì¤‘..."
          if sudo fallocate -l 100G /opt/backup/.reserve_space; then
            echo "âœ… fallocate ì‚¬ìš© ì„±ê³µ"
          else
            echo "âš ï¸ fallocate ì‹¤íŒ¨: dd ë°©ì‹ìœ¼ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤"
            sudo dd if=/dev/zero of=/opt/backup/.reserve_space bs=1M count=102400 || echo "âŒ dd ì‹¤íŒ¨: ë””ìŠ¤í¬ ìš©ëŸ‰ ë¶€ì¡±ìœ¼ë¡œ ì˜ˆì•½ ê³µê°„ í™•ë³´ ì‹¤íŒ¨"
          fi
          sudo chmod -R 777 /opt/backup
          echo "âœ… ë””ìŠ¤í¬ ìµœëŒ€ ìš©ëŸ‰ í™•ë³´ ë° ë””ë ‰í† ë¦¬ ì¤€ë¹„ ì™„ë£Œ" | tee -a backup-report.md
          echo "\n## ðŸ“¦ Disk Usage After Directory Setup" >> backup-report.md
          df -h >> backup-report.md

      - name: Split Workflow Files into Nano Units if Low Space
        run: |
          echo "\n## ðŸ§¬ Nano Backup Execution Logic" >> backup-report.md
          USAGE=$(df /opt | awk 'NR==2{print $5}' | sed 's/%//')
          if [ "$USAGE" -ge 90 ]; then
            echo "âš ï¸ ë””ìŠ¤í¬ ì‚¬ìš©ë¥ ì´ 90% ì´ìƒìž…ë‹ˆë‹¤. ìž‘ì—…ì„ ë‚˜ë…¸ ë‹¨ìœ„ë¡œ ë¶„í• í•©ë‹ˆë‹¤." | tee -a backup-report.md
            FILES=$(find .github/workflows -type f -name '*.yml')
            INDEX=0
            for FILE in $FILES; do
              SPLIT_PATH="/opt/backup/splits/workflow_$INDEX.yml"
              mkdir -p $(dirname "$SPLIT_PATH")
              split -l 20 "$FILE" "$SPLIT_PATH.part" && echo "ðŸ§© $FILE â†’ $SPLIT_PATH.part* ë¶„í• ë¨" >> backup-report.md
              INDEX=$((INDEX + 1))
            done
          else
            echo "âœ… ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ ì–‘í˜¸: ë‚˜ë…¸ ë‹¨ìœ„ ìž‘ì—… ë¶„í•  ë¶ˆí•„ìš”" >> backup-report.md
          fi
