name: Full System Automation with Backup, Test, and Reporting

on:
  push:
    branches:
      - main
  pull_request:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  full-backup:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set timestamp (KST)
      id: vars
      run: |
        export TZ=Asia/Seoul
        echo "timestamp=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
        echo "date_fmt=$(date '+%Y-%m-%d %H:%M:%S (KST)')" >> $GITHUB_OUTPUT

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y apache2 unzip curl default-jdk libaio-dev gnupg expect

    - name: Prepare backup directories
      run: |
        mkdir -p apache_backups nt-backup/bin db_backups oracle_backups teradata_backups backups reports eai_backups edi_logs springboot springboot_backups maven_backups public/reports

    - name: Setup Spring Boot JAR
      run: |
        curl -L https://repo.spring.io/release/org/springframework/boot/spring-boot-samples/2.7.3/spring-boot-samples-2.7.3.jar -o springboot/app.jar
        echo "java -jar $(pwd)/springboot/app.jar" > springboot/run.sh
        chmod +x springboot/run.sh

    - name: Generate .env and application.yml
      run: |
        echo "APP_ENV=production" > springboot/.env
        mkdir -p springboot/src/main/resources
        printf "spring:\n  application:\n    name: SampleApp\n  server:\n    port: 8080\n" > springboot/src/main/resources/application.yml

    - name: Install Maven
      run: |
        curl -LO https://downloads.apache.org/maven/maven-3/3.9.6/binaries/apache-maven-3.9.6-bin.zip
        unzip apache-maven-3.9.6-bin.zip -d ./maven_backups
        mv maven_backups/apache-maven-3.9.6 maven_backups/maven-${{ steps.vars.outputs.timestamp }}
        echo "$(pwd)/maven_backups/maven-${{ steps.vars.outputs.timestamp }}/bin" >> $GITHUB_PATH

    - name: Test Maven
      run: mvn --version

    - name: Run Spring Boot for test
      run: |
        nohup java -jar springboot/app.jar > springboot/run.log 2>&1 &
        sleep 10
        curl -s http://localhost:8080 || echo "No default route"
        pkill -f 'springboot/app.jar' || true

    - name: Backup Artifacts
      run: |
        cp springboot/app.jar springboot_backups/app-${{ steps.vars.outputs.timestamp }}.jar
        zip -r backups/workflows-backup-${{ steps.vars.outputs.timestamp }}.zip .github/workflows

    - name: Simulate and Encrypt Logistics Customer DB
      run: |
        echo "-- ë¬¼ë¥˜ ê³ ê° ê°€ìƒ ë°±ì—… (ì£¼ë¯¼ë²ˆí˜¸ ë§ˆìŠ¤í‚¹ ì ìš©)" > db_temp.sql
        echo "CREATE TABLE customers (id INT, name TEXT, phone TEXT, ssn TEXT);" >> db_temp.sql
        echo "INSERT INTO customers VALUES (1, 'í™ê¸¸ë™', '010-1234-5678', '900101-*******');" >> db_temp.sql
        echo "INSERT INTO customers VALUES (2, 'ê¹€ì² ìˆ˜', '010-9876-5432', '920305-*******');" >> db_temp.sql
        gpg --batch --yes --passphrase "secret" -c db_temp.sql
        mv db_temp.sql.gpg db_backups/db-backup-${{ steps.vars.outputs.timestamp }}.sql.gpg

    - name: Oracle DB Backup (encrypted)
      run: |
        echo "-- Oracle DB Export (simulated)" > oracle.dmp
        echo "EXPORT_DATE=${{ steps.vars.outputs.date_fmt }}" >> oracle.dmp
        gpg --batch --yes --passphrase "secret" -c oracle.dmp
        mv oracle.dmp.gpg oracle_backups/oracle-backup-${{ steps.vars.outputs.timestamp }}.dmp.gpg

    - name: Teradata Bank Batch (simulated)
      run: |
        echo "-- Teradata ìƒì£¼ë°°ì¹˜ (ì€í–‰ ê³ ê°ì •ë³´ ë§ˆìŠ¤í‚¹)" > td_batch.sql
        echo "CREATE TABLE bank_customers (id INT, name TEXT, ssn TEXT);" >> td_batch.sql
        echo "INSERT INTO bank_customers VALUES (1, 'ì´ì˜í¬', '880101-*******');" >> td_batch.sql
        echo "INSERT INTO bank_customers VALUES (2, 'ë°•ë¯¼ìˆ˜', '910205-*******');" >> td_batch.sql
        gpg --batch --yes --passphrase "secret" -c td_batch.sql
        mv td_batch.sql.gpg teradata_backups/td-backup-${{ steps.vars.outputs.timestamp }}.sql.gpg

    - name: Simulate EAI + EDI logs
      run: |
        echo "<msg><status>OK</status></msg>" > eai_backups/send-${{ steps.vars.outputs.timestamp }}.xml
        echo "<msg><status>OK</status></msg>" > eai_backups/receive-${{ steps.vars.outputs.timestamp }}.xml
        echo "$(date) ì†¡ì‹  ì™„ë£Œ" >> edi_logs/send.log
        echo "$(date) ìˆ˜ì‹  ì™„ë£Œ" >> edi_logs/receive.log

    - name: Analyze EAI logs
      id: eai
      run: |
        send_status=$(grep -oP '<status>\K[^<]+' eai_backups/send-${{ steps.vars.outputs.timestamp }}.xml)
        recv_status=$(grep -oP '<status>\K[^<]+' eai_backups/receive-${{ steps.vars.outputs.timestamp }}.xml)
        echo "send_status=$send_status" >> $GITHUB_OUTPUT
        echo "recv_status=$recv_status" >> $GITHUB_OUTPUT

    - name: Resource Usage
      id: sys
      run: |
        echo "cpu=$(top -bn1 | grep 'Cpu(s)' | awk '{print $2 + $4}')" >> $GITHUB_OUTPUT
        echo "memory=$(free | awk '/Mem/ {printf(\"%.2f\", $3/$2 * 100)}')" >> $GITHUB_OUTPUT
        echo "disk=$(df -h . | awk 'NR==2 {print $5}')" >> $GITHUB_OUTPUT

    - name: Cleanup Old Backups (24h)
      run: |
        find backups db_backups oracle_backups teradata_backups apache_backups nt-backup reports eai_backups springboot_backups edi_logs -type f -mmin +1440 -exec rm -v {} \;
        find maven_backups -depth -type d -mmin +1440 -exec rm -rv {} \;

    - name: Create Monitoring Report
      run: |
        REPORT=public/reports/report-${{ steps.vars.outputs.timestamp }}.md
        echo "# ğŸ“¦ ë°±ì—… ë¦¬í¬íŠ¸ (${{ steps.vars.outputs.date_fmt }})" > $REPORT
        echo "- Spring Boot: âœ…" >> $REPORT
        echo "- Maven: âœ…" >> $REPORT
        echo "- Oracle DB (ì•”í˜¸í™”ë¨): âœ…" >> $REPORT
        echo "- ë¬¼ë¥˜ ê³ ê° DB (ë§ˆìŠ¤í‚¹+ì•”í˜¸í™”): âœ…" >> $REPORT
        echo "- Teradata ì€í–‰ ìƒì£¼ë°°ì¹˜ (ë§ˆìŠ¤í‚¹+ì•”í˜¸í™”): âœ…" >> $REPORT
        echo "## EAI + EDI ìƒíƒœ" >> $REPORT
        echo "- ì†¡ì‹ : \\\\`OK\\\\`" >> $REPORT
        echo "- ìˆ˜ì‹ : \\\\`OK\\\\`" >> $REPORT
        echo "## ì‹œìŠ¤í…œ ìì›ìœ¨" >> $REPORT
        echo "- CPU: \\\\`${{ steps.sys.outputs.cpu }}%\\\\`" >> $REPORT
        echo "- Memory: \\\\`${{ steps.sys.outputs.memory }}%\\\\`" >> $REPORT
        echo "- Disk: \\\\`${{ steps.sys.outputs.disk }}\\\\`" >> $REPORT
        echo "\n[ğŸ” ë°±ì—… ëŒ€ì‹œë³´ë“œë¡œ ì´ë™](../index.html)" >> $REPORT

    - name: Commit Report
      run: |
        git config user.name github-actions
        git config user.email github-actions@github.com
        git pull origin main
        git add public/reports/*.md springboot_backups maven_backups db_backups oracle_backups teradata_backups backups eai_backups edi_logs
        git commit -m "ğŸ“¦ Backup + Report @ ${{ steps.vars.outputs.timestamp }}" || echo "Nothing to commit"
        git push origin main

  deploy:
    needs: full-backup
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true
        fetch-depth: 0

    - name: Setup Hugo
      uses: peaceiris/actions-hugo@v2
      with:
        hugo-version: '0.110.0'

    - name: Build Monitoring Page
      run: |
        mkdir -p public
        echo "<html><head><meta charset='utf-8'><title>ğŸ“¦ Backup Monitor</title></head><body><h1>ğŸ“¦ ë°±ì—… ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§ (24ì‹œê°„/365ì¼)</h1><ul>" > public/index.html
        for f in public/reports/*.md; do
          fname=$(basename "$f")
          echo "<li><a href='./reports/$fname'>$fname</a></li>" >> public/index.html
        done
        echo "</ul><hr><p>ì´ í˜ì´ì§€ëŠ” 5ë¶„ë§ˆë‹¤ ìë™ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.</p>" >> public/index.html
        echo "<h2>EDI ë¡œê·¸ ìƒíƒœ</h2>" >> public/index.html
        echo "<pre>" >> public/index.html
        tail -n 10 edi_logs/send.log >> public/index.html || true
        tail -n 10 edi_logs/receive.log >> public/index.html || true
        echo "</pre></body></html>" >> public/index.html

    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./public
