name: Global Card Transaction Backup (Encrypted UTC/KST)

on:
  schedule:
    - cron: '*/5 * * * *'  # 5λ¶„λ§λ‹¤ μ‹¤ν–‰
  workflow_dispatch:

permissions:
  contents: write

jobs:
  card-backup:
    runs-on: ubuntu-latest

    steps:
      - name: π“¦ Checkout
        uses: actions/checkout@v4

      - name: π•’ Set UTC + KST timestamps
        id: time
        run: |
          echo "utc_time=$(date -u +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
          echo "kst_time=$(TZ=Asia/Seoul date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: π“ Create backup directories
        run: mkdir -p checkcard_backups

      - name: π’³ Simulate Card Transactions and Encrypt
        run: |
          # μ²΄ν¬μΉ΄λ“ κ±°λ λ°±μ—…
          echo "-- μ²΄ν¬μΉ΄λ“ κ±°λ λ‚΄μ—­" > checkcard.sql
          echo "CREATE TABLE checkcard_transactions (id INT, customer_id INT, amount DECIMAL, masked_card TEXT);" >> checkcard.sql
          echo "INSERT INTO checkcard_transactions VALUES (1, 1001, 15000.00, '****-****-****-1234');" >> checkcard.sql

          # μ‹ μ©μΉ΄λ“ κ±°λ λ°±μ—…
          echo "-- μ‹ μ©μΉ΄λ“ κ±°λ λ‚΄μ—­" > creditcard.sql
          echo "CREATE TABLE creditcard_transactions (id INT, customer_id INT, amount DECIMAL, masked_card TEXT);" >> creditcard.sql
          echo "INSERT INTO creditcard_transactions VALUES (2, 2002, 32000.00, '****-****-****-5678');" >> creditcard.sql

          # GPG μ•”νΈν™”
          gpg --batch --yes --passphrase "secret" -c checkcard.sql
          gpg --batch --yes --passphrase "secret" -c creditcard.sql

          # νμΌ μ΄λ¦„μ— UTC + KST νƒ€μ„μ¤νƒ¬ν”„ ν¬ν•¨
          mv checkcard.sql.gpg checkcard_backups/checkcard-${{ steps.time.outputs.kst_time }}-UTC${{ steps.time.outputs.utc_time }}.sql.gpg
          mv creditcard.sql.gpg checkcard_backups/creditcard-${{ steps.time.outputs.kst_time }}-UTC${{ steps.time.outputs.utc_time }}.sql.gpg

          # μ›λ³Έ μ κ±°
          rm -f checkcard.sql creditcard.sql

      - name: β… Show backup files
        run: ls -al checkcard_backups
