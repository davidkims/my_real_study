name: CodeQL Analysis Fix

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  generate-and-run-codeql:
    name: Generate & Run CodeQL (Safe)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate .github/workflows/codeql.yml safely
        run: |
          mkdir -p .github/workflows
          {
            echo "name: CodeQL Analysis"
            echo ""
            echo "on:"
            echo "  push:"
            echo "    branches: [ \"main\" ]"
            echo "  pull_request:"
            echo "    branches: [ \"main\" ]"
            echo ""
            echo "permissions:"
            echo "  security-events: write"
            echo ""
            echo "jobs:"
            echo "  analyze:"
            echo "    name: Analyze code"
            echo "    runs-on: ubuntu-latest"
            echo "    strategy:"
            echo "      fail-fast: false"
            echo "    steps:"
            echo "      - name: Checkout"
            echo "        uses: actions/checkout@v4"
            echo ""
            echo "      - name: Initialize CodeQL"
            echo "        uses: github/codeql-action/init@v3"
            echo "        with:"
            echo "          languages: javascript, python, java"
            echo ""
            echo "      - name: Check for supported code"
            echo "        id: code-check"
            echo "        run: |"
            echo "          if ! find . -name \"*.java\" -o -name \"*.py\" -o -name \"*.js\" | grep -q .; then"
            echo "            echo \"No supported CodeQL languages found.\""
            echo "            echo \"skip=true\" >> \$GITHUB_OUTPUT"
            echo "          else"
            echo "            echo \"Supported source code detected.\""
            echo "            echo \"skip=false\" >> \$GITHUB_OUTPUT"
            echo "          fi"
            echo ""
            echo "      - name: Run CodeQL analysis"
            echo "        if: steps.code-check.outputs.skip != 'true'"
            echo "        uses: github/codeql-action/analyze@v3"
          } > .github/workflows/codeql.yml

      - name: Commit codeql.yml
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/workflows/codeql.yml
          git diff --cached --quiet || git commit -m "üîê Generate safe CodeQL workflow"
          git push || echo "No changes to push"

      - name: Re-run CodeQL as sub-job
        uses: actions/github-script@v7
        with:
          script: |
            core.info('‚úÖ CodeQL workflow file has been generated and committed.')
