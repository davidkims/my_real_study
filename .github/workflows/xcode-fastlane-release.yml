name: Swift CLI Build and Release

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  build-release:
    runs-on: macos-13
    timeout-minutes: 30

    env:
      PROJECT_NAME: DummyApp
      PROJECT_DIR: ${{ github.workspace }}/DummyApp
      VERSION_TAG: v${{ github.run_number }}-$(date +%Y%m%d)

    steps:
      - name: âœ… Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ“ Create Swift CLI Project
        run: |
          mkdir -p DummyApp/Sources/DummyApp
          cd DummyApp
          swift package init --type executable
          echo 'print("âœ… Hello from Swift CLI App")' > Sources/DummyApp/main.swift

      - name: ðŸ“‚ Ensure Directories Exist
        run: |
          mkdir -p logs artifacts

      - name: ðŸ›  Build with Xcode
        run: |
          cd "$PROJECT_DIR"
          echo "ðŸ›  Building with xcodebuild..."
          xcodebuild -scheme DummyApp -destination 'platform=macOS' clean build \
            | tee "$GITHUB_WORKSPACE/logs/xcodebuild.log"

      - name: ðŸ”– Create Git Tag
        run: |
          cd "$PROJECT_DIR"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "${VERSION_TAG}"
          git push origin "${VERSION_TAG}"

      - name: ðŸš€ Create GitHub Release
        run: |
          cd "$PROJECT_DIR"
          echo "ðŸ“¦ Creating GitHub release for tag: $VERSION_TAG"
          gh release create "$VERSION_TAG" \
            --title "$VERSION_TAG" \
            --notes "âœ… Swift CLI build completed on $(date)"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“¦ Archive Build Artifacts
        run: |
          cd "$PROJECT_DIR"
          mkdir -p ../artifacts
          zip -r ../artifacts/${PROJECT_NAME}.zip . || true

      - name: ðŸ“¤ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: swift-cli-artifacts
          path: |
            artifacts/
            logs/
