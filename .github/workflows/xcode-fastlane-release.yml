name: Swift CLI Build + GitHub Release

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  swift-cli-build:
    runs-on: macos-13
    timeout-minutes: 60

    env:
      PROJECT_NAME: DummyApp
      PROJECT_DIR: ${{ github.workspace }}/DummyApp
      VERSION_TAG: v${{ github.run_number }}-$(date +%Y%m%d)

    steps:
      - name: âœ… Checkout
        uses: actions/checkout@v4

      - name: ðŸ“ Create Swift CLI Project (if none)
        run: |
          mkdir -p DummyApp/Sources/DummyApp
          cd DummyApp
          swift package init --type executable
          echo "print(\"âœ… Hello from Swift CLI App\")" > Sources/DummyApp/main.swift

      - name: ðŸ›  Build Swift CLI App (xcodebuild)
        run: |
          cd "$PROJECT_DIR"
          echo "ðŸ›  Running: xcodebuild -scheme DummyApp"
          xcodebuild -scheme DummyApp -destination 'platform=macOS' clean build | tee ../../logs/xcodebuild.log

      - name: ðŸ”– Create Git Tag
        run: |
          cd "$PROJECT_DIR"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "${VERSION_TAG}"
          git push origin "${VERSION_TAG}"

      - name: ðŸš€ GitHub Release
        run: |
          gh release create "${VERSION_TAG}" \
            --title "${VERSION_TAG}" \
            --notes "âœ… CLI build via CI on $(date)"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“¦ Archive Build Artifacts
        run: |
          cd "$PROJECT_DIR"
          mkdir -p ../artifacts
          zip -r ../artifacts/${PROJECT_NAME}.zip . || true

      - name: ðŸ“¤ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: swift-cli-artifacts
          path: artifacts/
