name: "🔐 Xanitizer Mega Security Analysis"

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '18 9 * * 6'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  xanitizer-sast:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: ✅ Checkout Source
        uses: actions/checkout@v4

      - name: 🔧 Install Required Programs
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip curl jq libaio-dev

      - name: ☕ Setup Java 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: 🧰 Setup Maven
        uses: s4u/setup-maven-action@v1.8.0
        with:
          maven-version: '3.9.6'

      - name: 📦 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: 🗂️ Create Required Folders
        run: |
          mkdir -p logs reports dist build target

      - name: 🔨 Compile Java Code
        run: mvn -B compile

      - name: 📥 Install JavaScript Dependencies (if applicable)
        run: |
          if [ -f "package.json" ]; then
            npm install
          else
            echo "⚠️ package.json not found. Skipping npm install."
          fi

      - name: 🔍 Check for Xanitizer License
        id: check_license
        run: |
          if [ -z "${{ secrets.XANITIZER_LICENSE }}" ]; then
            echo "❌ Xanitizer license not found. Skipping scan step."
            echo "run_scan=false" >> $GITHUB_OUTPUT
          else
            echo "✅ License found."
            echo "run_scan=true" >> $GITHUB_OUTPUT
          fi

      - name: 🔍 Run Xanitizer Security Analysis
        if: steps.check_license.outputs.run_scan == 'true'
        uses: RIGS-IT/xanitizer-action@87d13138fb113b727cbe040c744a15a2b4fe5316
        with:
          license: ${{ secrets.XANITIZER_LICENSE }}

      - name: 📄 Archive Reports if Available
        if: steps.check_license.outputs.run_scan == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: Xanitizer-Reports
          path: |
            *-Findings-List.pdf
            *-Findings-List.sarif

      - name: 🚨 Upload SARIF to GitHub Code Scanning
        if: steps.check_license.outputs.run_scan == 'true' && hashFiles('*-Findings-List.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: Xanitizer-Findings-List.sarif
